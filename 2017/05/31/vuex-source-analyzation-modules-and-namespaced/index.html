<!DOCTYPE html><html lang="#{config.language}"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="chen wen jun's blog"><meta name="baidu-site-verification" content="no5dkv1A7T"><title>从vuex源码分析module与namespaced | EL PSY CONGROO</title><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="/js/main.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css"><script type="text/javascript" src="/js/post.js"></script><meta name="generator" content="Hexo 5.4.2"></head><body></body><div id="header"><div class="body_container"><div id="nav-menu"><a class="current" href="/."> 主页</a><a href="/archives/"> 归档</a><a target="_blank" rel="noopener" href="https://next.yo-cwj.com"> 项目</a><a href="/about/"> 关于</a></div><div class="site-name"><img class="avatar" src="/./img/avatar.png"><br><h1 class="hidden">从vuex源码分析module与namespaced</h1><a id="logo" href="/.">EL PSY CONGROO</a><p class="description">陈文俊的博客</p><p class="links"><a target="_blank" rel="noopener" href="https://segmentfault.com/u/xpang"><img src="/./img/sf.ico"></a><a target="_blank" rel="noopener" href="https://github.com/cwj0417"><img src="/./img/github.png"></a><a target="_blank" rel="noopener" href="https://dribbble.com/fjonas"><img src="/./img/dribbble.ico"></a><a target="_blank" rel="noopener" href="https://weibo.com/2719310113"><img src="/./img/weibo.ico"></a></p></div></div></div><div class="body_container"><div class="pure-g" id="layout"><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-paperclip"> </i>标签</div><div class="tagcloud"><a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" style="font-size: 15px;">年终总结</a> <a href="/tags/angular/" style="font-size: 15px;">angular</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" style="font-size: 15px;">代码组织</a> <a href="/tags/%E5%BA%94%E7%94%A8/" style="font-size: 15px;">应用</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 15px;">心理学</a> <a href="/tags/%E4%BA%BA%E6%A0%BC%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 15px;">人格心理学</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E8%A3%85%E9%A5%B0/" style="font-size: 15px;">博客装饰</a> <a href="/tags/immer/" style="font-size: 15px;">immer</a> <a href="/tags/vscode/" style="font-size: 15px;">vscode</a> <a href="/tags/vue%E6%BA%90%E7%A0%81/" style="font-size: 15px;">vue源码</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a> <a href="/tags/webpack/" style="font-size: 15px;">webpack</a> <a href="/tags/electron/" style="font-size: 15px;">electron</a> <a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 15px;">入门</a> <a href="/tags/chrome-extension/" style="font-size: 15px;">chrome extension</a> <a href="/tags/%E9%A2%9C%E8%89%B2/" style="font-size: 15px;">颜色</a> <a href="/tags/eslint/" style="font-size: 15px;">eslint</a> <a href="/tags/vite/" style="font-size: 15px;">vite</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 15px;">翻译</a> <a href="/tags/d3/" style="font-size: 15px;">d3</a> <a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 15px;">分析</a> <a href="/tags/%E8%B5%84%E6%9C%AC%E8%AE%BA/" style="font-size: 15px;">资本论</a> <a href="/tags/ci/" style="font-size: 15px;">ci</a> <a href="/tags/github-action/" style="font-size: 15px;">github action</a> <a href="/tags/svg/" style="font-size: 15px;">svg</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/%E6%B7%B1%E5%85%A5es6/" style="font-size: 15px;">深入es6</a> <a href="/tags/http/" style="font-size: 15px;">http</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/haha/" style="font-size: 15px;">haha</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">小程序</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/%E4%BA%94%E8%A1%8C%E5%85%AB%E5%8D%A6/" style="font-size: 15px;">五行八卦</a> <a href="/tags/vuex/" style="font-size: 15px;">vuex</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 15px;">抓包</a> <a href="/tags/hook/" style="font-size: 15px;">hook</a> <a href="/tags/typescript/" style="font-size: 15px;">typescript</a> <a href="/tags/monorepo/" style="font-size: 15px;">monorepo</a> <a href="/tags/jenkins/" style="font-size: 15px;">jenkins</a> <a href="/tags/redux/" style="font-size: 15px;">redux</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 15px;">正则</a> <a href="/tags/esbuild/" style="font-size: 15px;">esbuild</a> <a href="/tags/%E7%9B%B8%E5%AF%B9%E8%AE%BA/" style="font-size: 15px;">相对论</a> <a href="/tags/cordova/" style="font-size: 15px;">cordova</a> <a href="/tags/vite-plugin/" style="font-size: 15px;">vite-plugin</a> <a href="/tags/weex/" style="font-size: 15px;">weex</a> <a href="/tags/%E9%98%BF%E5%BE%B7%E5%8B%92/" style="font-size: 15px;">阿德勒</a> <a href="/tags/%E9%81%93%E5%BE%B7%E6%83%85%E6%93%8D%E8%AE%BA/" style="font-size: 15px;">道德情操论</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-commenting-o"> </i>最近评论</div><div class="epcRecentComments" id="cyReping" role="cylabs" data-use="reping"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> </i>友情链接</div><div class="links"><a href="#{theme.links[i].url}" title="#{theme.links[i].title}" target="_blank">sean(大数据专家, 人工智能专家)</a><a href="#{theme.links[i].url}" title="#{theme.links[i].title}" target="_blank">abel(大数据专家, 人工智能专家)</a><a href="#{theme.links[i].url}" title="#{theme.links[i].title}" target="_blank">bruce(大数据专家, 人工智能专家)</a><a href="#{theme.links[i].url}" title="#{theme.links[i].title}" target="_blank">邓雪(全栈开发专家)</a><a href="#{theme.links[i].url}" title="#{theme.links[i].title}" target="_blank">赵吉(后现代浪漫主义诗人)</a><a href="#{theme.links[i].url}" title="#{theme.links[i].title}" target="_blank">98年新栋(首席实习生)</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从vuex源码分析module与namespaced</h1><div class="post-meta">May 31, 2017<span> | </span><span class="category"><a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span></div><div class="post-content"><p>使用vue已经有半年有余, 在各种正式非正式项目中用过, 开始专注于业务比较多, 用到现在也遇见不少因为理解不深导致的问题. 有问题就有找原因的勇气, 所以带着问题搞一波.</p>
<span id="more"></span>

<h2 id="带着问题看源码"><a href="#带着问题看源码" class="headerlink" title="带着问题看源码"></a>带着问题看源码</h2><p>所以来整理了一下使用过程中不注意或者不规范, 或者简化写法的奇技淫巧, 会结合文档的说明和实际的问题来看看源码, 问题:</p>
<ul>
<li>module在vuex里实际的数据结构</li>
<li>namespaced在vuex里实际的数据结构</li>
<li>mapState, mapActions等helper的正确用法(配合module/namespaced), 或者是否存在更多骚用法</li>
<li>mutation中赋值/触发state变化原理</li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>看的源码版本为vuex2.3.1</p>
<p>我们使用vuex可能是类似:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Vuex</span> <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">import</span> plugins <span class="keyword">from</span> <span class="string">&#x27;./plugins&#x27;</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">Vuex</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">        <span class="attr">todo</span>: [<span class="string">&quot;todo1&quot;</span>, <span class="string">&quot;todo2&quot;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">        <span class="title function_">mutationName</span>(<span class="params">state, payload</span>) &#123;</span><br><span class="line">            state.<span class="property">xxx</span> = payload.<span class="property">xxx</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">        <span class="title function_">actionName</span>(<span class="params">&#123; commit, dispatch &#125;, payload</span>) &#123;</span><br><span class="line">            <span class="title function_">commit</span>(mutationName, payload)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">        <span class="attr">catagories</span>: &#123;</span><br><span class="line">            <span class="attr">state</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">mutations</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>使用vuex的方法为使用<code>Vue.use</code>来install<code>vuex</code>, 并new一个Store实例, 我们来看一下vuex核心对象.</p>
<h3 id="Store对象分析"><a href="#Store对象分析" class="headerlink" title="Store对象分析"></a>Store对象分析</h3><p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L6">line6</a>: 本地vue变量, 在install时会被赋值, 之后会通过vue是否为<code>undefined</code>来判断是否install</p>
<h4 id="Store对象构建"><a href="#Store对象构建" class="headerlink" title="Store对象构建"></a>Store对象构建</h4><p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L10">line10~14</a>: 判断vuex是否被正确使用<br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L16">line16~26</a>: 获取options, <strong><code>state</code>可以和vue的component的<code>data</code>一样为函数return一个对象, 会在这段代码中被parse</strong><br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L28">line28~36</a>: <a href="#store%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F%E5%88%9D%E5%A7%8B%E5%8C%96">store对象内部变量初始化</a><br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L39">line39~46</a>: 绑定commit和dispatch方法到自身<br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L54">line54</a>: 装载动作<br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L58">line58</a>: 装载响应动作<br><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L61">line61</a>: 调用插件</p>
<h4 id="store内部变量初始化"><a href="#store内部变量初始化" class="headerlink" title="store内部变量初始化"></a>store内部变量初始化</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_committing</span> = <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>是否合法更新state的标识, 对象有方法<code>_withCommit</code>是唯一可以改动<code>_committing</code>的方法, 只有对象内部使用<code>_withCommit</code>更新状态才是合法的, 在<code>strict</code>模式下非法更新state会抛出异常.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_modules</span> = <span class="keyword">new</span> <span class="title class_">ModuleCollection</span>(options)</span><br></pre></td></tr></table></figure>

<p>modules的cache, 直接把store的参数全部扔给了<code>ModuleCollection</code>新建一个modules对象.</p>
<p>点击跳转<a href="#ModuleCollection%E5%AF%B9%E8%B1%A1">ModuleCollection对象</a>来看分析.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_modulesNamespaceMap</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_subscribers</span> = []</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_watcherVM</span> = <span class="keyword">new</span> <span class="title class_">Vue</span>()</span><br></pre></td></tr></table></figure>

<p><a href="#Store%E5%AF%B9%E8%B1%A1%E6%80%BB%E7%BB%93">其余的变量</a>是新建了空的变量, 之后会在<a href="#install%E6%A8%A1%E5%9D%97">install模块</a>的时候赋值.</p>
<h4 id="绑定dispatch和commit方法"><a href="#绑定dispatch和commit方法" class="headerlink" title="绑定dispatch和commit方法"></a>绑定dispatch和commit方法</h4><p>在<a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L39">line39~46</a>, 对dispatch和commit方法进行绑定, 使dispatch方法可以调用在Store对象上注册过的<code>._actions</code></p>
<p>和<code>._mutations</code>的方法.</p>
<p>dispatch方法在<a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L108">line108</a>, 先兼容了参数的写法, 取到参数, 然后判断Store对象的<code>_.actions</code>属性是否注册过, 如果注册过多个, 将会<strong>依次调用</strong>. 也就是如果type重复了也是会调用多次的, 这个地方如果出错debug会非常困难. 暂时没有理解vuex此处设计的意图.</p>
<p>commit方法稍微多一点, 大体思路是一样的, 只是直接执行没有返回值, dispatch会返回执行结果. 另外在<a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L95">line95</a>进行了subscriber的操作, 我们暂且不知道subscriber的作用. 稍后再看.</p>
<h4 id="install模块"><a href="#install模块" class="headerlink" title="install模块"></a>install模块</h4><p>首先来看参数:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">installModule</span> (store, rootState, path, <span class="variable language_">module</span>, hot)</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="title function_">installModule</span>(<span class="variable language_">this</span>, state, [], <span class="variable language_">this</span>.<span class="property">_modules</span>.<span class="property">root</span>)</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L255">line255</a> 根据path获得namespace, 做法是读取path的每个模块, 如果namespaced为true则拼接, 例如path为<code>[&#39;catagories&#39;, &#39;price&#39;, &#39;detail&#39;]</code>, 其中<code>price</code>的namespaced为false, 其余为true, 那么获得的namespace为<code>catagories/detail/</code>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L260">line258~260</a> 把namespaced为true的module注册到<code>_modulesNamespaceMap</code>.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L271">line271</a>的<code>makeLocalContext</code>函数整理了namespace和type的关系. 在之后的三个<code>module.forEachXxx</code>中, 都调用了<code>registerXxx</code>, 最后的参数都是<code>makeLocalContext</code>的返回值.  我们来分析一下<code>makeLocalContext</code>的作用:</p>
<p>被注册到全局的mutation/actiongetter实际的type类似于<code>namespace1/namespace2/type</code>的形式, 而我们在namespaced为true的module中调用的type只是:<code>type</code>. 所以在namespace[true]的action中调用的所有<code>dispatch</code>, <code>commit</code>, <code>getter</code>, <code>state</code> 都会被加上  path.join(“/“) + “/“  的type来调用到正确的方法.</p>
<p>根据注册的type, 我还得到了一个偏门结论: <strong>可以通过设置type为<code>namespace1/namespace2/type</code>来调用其他namespace的type</strong>(待测试), 因为他们是这样被注册的.</p>
<h4 id="install-child-module"><a href="#install-child-module" class="headerlink" title="install child module"></a>install child module</h4><p>通过比较, install child module的时候是改了第三第四个参数: <code>path</code> =&gt; <code>path.concat(key)</code>, <code>module</code> =&gt; <code>module.getChild(key)</code>.</p>
<p>主要区别只是在<a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L264">line264~268</a>, 与<a href="#%E9%80%92%E5%BD%92register%E5%AD%90module">ModuleCollection的递归注册子module</a>行为类似, 递归的path参数流程上只是多了一步把当前loop产生的对象挂到父节点上. 做法也是一样的, 把module名字(path)作为key, 套在父级state上. 也就是结构为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">state</span>: &#123;</span><br><span class="line">  ...currentState,</span><br><span class="line">  <span class="attr">moduleName</span>: &#123;</span><br><span class="line">    ...subState</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">module2Name</span>: &#123;</span><br><span class="line">    ...anotherSubState</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在之前注册Mutation的时候vuex也是通过这个方法来试mutation获得嵌套过的state作为arguments[0]的.</p>
<h4 id="Store对象总结"><a href="#Store对象总结" class="headerlink" title="Store对象总结"></a>Store对象总结</h4><p>store对象把传入的options放入了各个变量进行储存, 并提供了commit, dispatch等方法来调用和处理他们:</p>
<h5 id="modules"><a href="#modules" class="headerlink" title="._modules"></a><code>._modules</code></h5><p>这里存放raw的modules, 未经处理的, 以module名字作为key的方式递归子module.</p>
<h5 id="state"><a href="#state" class="headerlink" title=".state"></a><code>.state</code></h5><p>这里也是以module名字作为key的方式递归储存传入的state</p>
<h5 id="entrys"><a href="#entrys" class="headerlink" title="entrys"></a>entrys</h5><p>这里的entry指<code>._actions</code>, <code>._mutations</code>, <code>._getters</code>. 他们的储存方式并没有递归储存key, 而是平级的, 用<code>/</code>来分割namespace来分辨type, 并在注册时把当前的entry绑定对应的state(通过<code>getNestedState</code>方法).</p>
<p>问题: 如果在不同module注册了相同type的mutation, 会发生什么?</p>
<p>回答: 会依次在自己的state中执行, 不会影响对方state, 但是会造成错误执行. (待测试). 所以应该在大的项目中尽量使用namespaced[true]的方式, 而不是命名的方式.(但是也是可以利用<code>/</code>来串namespace的, 所以自己type命名避免<code>/</code>)</p>
<h5 id="modulesNamespaceMap"><a href="#modulesNamespaceMap" class="headerlink" title="._modulesNamespaceMap"></a><code>._modulesNamespaceMap</code></h5><p>根据namespace为key来存放子module</p>
<h4 id="初始化Store-VM"><a href="#初始化Store-VM" class="headerlink" title="初始化Store VM"></a>初始化Store VM</h4><p>这里会新建一个Vue实例并赋值给Store对象的<code>._vm</code>属性, 把整个vuex的状态放进去. 并判断严格模式, 如果为严格模式会在非法改变状态的时候抛出异常.</p>
<p>这样整个构建动作已经完成了, 那么这个<code>._vm</code>在什么时候用的, 请看下面的章节.</p>
<h3 id="Store对象的属性-amp-方法"><a href="#Store对象的属性-amp-方法" class="headerlink" title="Store对象的属性&amp;方法"></a>Store对象的属性&amp;方法</h3><p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L64">line64</a> state的getter方法, 会获取<code>._vm</code>的vue实例的state. 所以我们在vue代码中<code>this.$store.state.xxx</code>获取到的东西就是这个vue的实例的数据.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex/blob/v2.3.0/src/store.js#L68">line68</a> 当直接set Store的state时报错, 只能通过设置<code>._vm</code>来进行.</p>
<p>剩余的方法的是vuex的进阶用法, 是可以在使用时对vuex状态进行操作的方法, 详见<a target="_blank" rel="noopener" href="http://vuex.vuejs.org/en/api.html#vuexstore-instance-methods">文档</a></p>
<h3 id="ModuleCollection对象"><a href="#ModuleCollection对象" class="headerlink" title="ModuleCollection对象"></a>ModuleCollection对象</h3><p>我们来看下<code>ModuleCollection</code>的构造方法.</p>
<h4 id="register根module"><a href="#register根module" class="headerlink" title="register根module"></a>register根module</h4><p>调用了<code>register</code>方法, 把参数的path设为根目录, runtime设为false.</p>
<p><code>register</code>方法一开始(l30)就判断了除<code>state</code>外的属性的值是否为函数, 若不是则抛出异常.</p>
<p>line33 把module参数(还是初始的options, 就是<code>&#123;state:&#123;...&#125;, mutations:&#123;...&#125;, actions: &#123;...&#125;&#125;</code>这个)和runtime = false 来构建了<code>Module</code>对象(稍后我们看Module对象的构造)</p>
<p>line35 把<code>ModuleCollection</code>的root私有变量设为了刚才使用初始options新建的<code>Module</code>对象.</p>
<p>line42 如果初始options有modules这个属性, 就开始递归注册modules. </p>
<h4 id="递归register子module"><a href="#递归register子module" class="headerlink" title="递归register子module"></a>递归register子module</h4><p>上面是<code>register</code>的第一个参数<code>path</code>为空, 也就是root节点的时候的流程, 在最后一部分(line42)根据是否当前注册的module含有modules属性来递归注册, 这部分我们来看一下register的path参数的行为会把数据存成什么结构. 以<a href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">概览</a>部分的例子的参数为例(modules含有一个key为<code>catagories</code>)来走一遍代码流程. (开始~)</p>
<p>被作为子module传入<code>register</code>方法的参数应该为: <code>path</code>([‘catagories’]), <code>rawModule</code>(state: {},mutations: {}), <code>runtime</code>(false).</p>
<p>注意到的是, 如果<code>catagories</code>有同级module, 被传入的<code>path</code>也是一个元素的数组, 也就是path的意思应该类似于从跟到当前module的层级, 对于兄弟节点是无感的.</p>
<p>这里的<code>runtime</code>尚未明白用途, 可能是在别处调用的. 注册流程应该runtime都为false.</p>
<p>一路看下来, 也是new了一个<code>Module</code>对象, 但是没有走到line35把new出的对象放到<code>root</code>变量里, 而是在line37~38去寻找当前module的父节点并把自己作为child, append到父节点上.</p>
<p>这里又脑补了一下数据结构: <code>path.slice(0, -1)</code>是获取被pop()一下的path, <code>path[path.lengt - 1]</code>是获取当前path的最后一个元素, 也就是当前正在被register的module的key. 所以之前对于path的数据结构判断是正确的.</p>
<p>这里的<code>appendChild</code>和<code>getChild</code>很明显是<code>Module</code>对象的方法了, 我们再继续看<code>Module</code>对象的结构.</p>
<h4 id="Module对象"><a href="#Module对象" class="headerlink" title="Module对象"></a><code>Module</code>对象</h4><p>最后来看<code>Module</code>对象的构造~</p>
<p>接受2个参数, 一个<code>rawModule</code>, 一个<code>runtime</code>, 第一个参数是刚才相对于key为<code>catagories</code>的value, 也就是类似<code>&#123;state: xxx, mutations: xxx, actions: xxx&#125;</code>的options. </p>
<p><code>Module</code>的构造函数只是把参数拆分, 放入了自己的私有变量, 其中<code>state</code>也接受函数, 并执行函数parse成对象存入私有变量. 其他变量都是原封不动储存的, 所以vuex给他起名为 <strong>raw</strong>Module 吧. 剩下那些方法都是顾名思义的, 语法上也简单, 没什么好看的.</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>那么这样Store对象的<code>._modules</code>属性的数据结构已经很清楚了. 类似于(脑内):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// (ModuleCOllection实例)</span></span><br><span class="line">  <span class="attr">root</span>: &#123;</span><br><span class="line">    <span class="comment">// (Module实例)</span></span><br><span class="line">    <span class="attr">_rawModule</span>: &#123;</span><br><span class="line">      <span class="attr">state</span>: &#123;...&#125;, <span class="attr">mutations</span>: &#123;...&#125;, <span class="comment">// ...(全是options直接传入)</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">state</span>: &#123;&#125;, <span class="comment">// 进行过parse的state, 如果是function会调用并赋值</span></span><br><span class="line">    <span class="attr">_children</span>: &#123;</span><br><span class="line">      <span class="attr">catagories</span>: &#123;</span><br><span class="line">        <span class="comment">// (Module实例)</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">anotherModule</span>: &#123;</span><br><span class="line">        <span class="comment">// (Module实例), 递归</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一点, 就是这里贮存的数据都是”raw”的.</p>
<h2 id="helpers"><a href="#helpers" class="headerlink" title="helpers"></a>helpers</h2><p>所有的helper都用了两个wrap方法, 先来看下这两个方法的作用.</p>
<h4 id="normalizeNamespace"><a href="#normalizeNamespace" class="headerlink" title="normalizeNamespace"></a><code>normalizeNamespace</code></h4><p>因为helper是都接受两种传参方式:<code>mapState(namespace, map)</code> / <code>mapState(map)</code> , 如果第一个参数为map时这个函数把namespace设为空字符串 , 并且检查namespace的最后一个字符是不是<code>/</code>, 如果不是的话加上.</p>
<h4 id="normalizeMap"><a href="#normalizeMap" class="headerlink" title="normalizeMap"></a><code>normalizeMap</code></h4><p>我们map的内容也接受两种语法:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">&quot;state1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;state2&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>或者是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">state1</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">state1</span>,</span><br><span class="line">  <span class="attr">state2</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">state2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个wrap函数会把两种形式都normalize为含有<code>key</code>和<code>val</code>属性的数组, 便于统一处理. 也就是上面个两个形式会转化为:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Array like</span></span><br><span class="line">[&#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;state1&quot;</span>,</span><br><span class="line">  <span class="attr">val</span>: <span class="string">&quot;state1&quot;</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;state2&quot;</span>,</span><br><span class="line">  <span class="attr">val</span>: <span class="string">&quot;state2&quot;</span></span><br><span class="line">&#125;]</span><br><span class="line"><span class="comment">// Object like</span></span><br><span class="line">[&#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;state1&quot;</span>,</span><br><span class="line">  <span class="attr">val</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">state1</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="attr">key</span>: <span class="string">&quot;state2&quot;</span>,</span><br><span class="line">  <span class="attr">val</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">state2</span></span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>

<h4 id="mapState"><a href="#mapState" class="headerlink" title="mapState"></a>mapState</h4><p>这里做了2个处理: </p>
<ul>
<li>如果namespace不为空, 把state和getter的环境切换到相对于namespace的环境(就是之前的<code>makeLocalContext</code>的返回值)</li>
<li>如果val为函数则执行, 否则返回state的val为键的属性. 两者的执行环境皆为处理过namespace的local环境.</li>
</ul>
<h4 id="mapActions"><a href="#mapActions" class="headerlink" title="mapActions"></a>mapActions</h4><p>mapAction的val语法只接受字符串的, 所以先把val前借namespace, 变为: <code>namespace/val</code>, 这样能符合在Store里注册的entry名. </p>
<p>然后检查了一下namespace是否被注册过, 也就是防碰撞, 然后把val作为type, 并把剩余参数带着dispatch Store里的action.</p>
<hr>
<p>参考:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://tech.meituan.com/vuex-code-analysis.html">美团vuex源码分析</a></li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="#{page.permalink}" data-id="#{page._id}">分享到</a><div class="post-footer"></div><p> (本文完)</p><p> 如果你觉得本文对你有帮助, 你可以<a href="/about/give-me-a-coffee.html">请我喝一杯咖啡</a></p><p> 本文遵循<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">cc协议</a></p><p> 你可以在注明出处和非商用的前提下任意复制及演绎</p><div class="post-footer"></div><div class="tags"><a href="/tags/vue/">vue</a><a href="/tags/%E5%88%86%E6%9E%90/">分析</a><a href="/tags/vuex/">vuex</a></div><div class="post-nav"><a class="pre" href="/2017/06/13/build-an-application-with-electron-and-vue-app-structrue/">用electron与vue构建应用--应用结构</a><a class="next" href="/2017/03/02/vue2filter/">vue2.0 filter替代方案</a></div><div id="SOHUCS"></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><p>©&nbsp;<a href="/." rel="nofollow">EL PSY CONGROO. </a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/">沪ICP备16053193号-2</a></p><p>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> | Designed by cutie</p><p>  <img src="https://s01.flagcounter.com/count/SNs9/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_4/viewers_3/labels_1/pageviews_0/flags_0/percent_0/"/></p></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="https://cy-cdn.kuaizhan.com/js/??lib/jquery.js,changyan.labs.https.js?appid=cyt1bgEED" async></script><script>(function () {
    var appid = 'cyt1bgEED';
    var conf = 'prod_20e8d05c4d6b3ce62b89be98ae18390c';
    var width = window.innerWidth || document.documentElement.clientWidth;
    if (width < 960) {
        var head = document.getElementsByTagName('head')[0]||document.head||document.documentElement;
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.charset = 'utf-8';
        script.id = 'changyan_mobile_js';
        script.src = 'https://cy-cdn.kuaizhan.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
        head.appendChild(script);
    } else {
        var loadJs=function(d,a){
        var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;
        var b=document.createElement("script");
        b.setAttribute("type","text/javascript");
        b.setAttribute("charset","UTF-8");b.setAttribute("src",d);
        if(typeof a==="function"){
          if(window.attachEvent){
            b.onreadystatechange=function(){
              var e=b.readyState;
              if(e==="loaded"||e==="complete"){
                b.onreadystatechange=null;
                a();
              }
            }
            }else{
              b.onload=a
            }
          }
          c.appendChild(b)
        };
      loadJs("https://cy-cdn.kuaizhan.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})});
    }
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div><script type="text/javascript"> var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1273985214'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1273985214%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></html>