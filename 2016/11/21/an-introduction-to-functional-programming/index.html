<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="chen wen jun's blog"><meta name="baidu-site-verification" content="no5dkv1A7T"><title>函数式编程介绍 | EL PSY CONGROO</title><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="/js/main.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css"><script type="text/javascript" src="/js/post.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body></body><div id="header"><div class="body_container"><div id="nav-menu"><a class="current" href="/."> 主页</a><a href="/archives/"> 归档</a><a target="_blank" rel="noopener" href="https://next.yo-cwj.com"> 项目</a><a href="/about/"> 关于</a></div><div class="site-name"><img class="avatar" src="/./img/avatar.png"><div class="theme-selector"><div class="selector" onclick="document.body.className = 't1';localStorage.setItem('yo-cwj-theme', 't1')" style="background: #00c7ff;"></div><div class="selector" onclick="document.body.className = 't2';localStorage.setItem('yo-cwj-theme', 't2')" style="background: #ffe100;"></div><div class="selector" onclick="document.body.className = 't3';localStorage.setItem('yo-cwj-theme', 't3')" style="background: #55ff00;"></div></div><br><h1 class="hidden">函数式编程介绍</h1><a id="logo" href="/.">EL PSY CONGROO</a><p class="description">陈文俊的博客</p><p class="links"><a target="_blank" rel="noopener" href="https://segmentfault.com/u/xpang"><img src="/./img/sf.ico"></a><a target="_blank" rel="noopener" href="https://github.com/cwj0417"><img src="/./img/github.png"></a><a target="_blank" rel="noopener" href="https://dribbble.com/fjonas"><img src="/./img/dribbble.ico"></a><a target="_blank" rel="noopener" href="https://weibo.com/2719310113"><img src="/./img/weibo.ico"></a></p></div></div></div><div class="body_container"><div class="pure-g" id="layout"><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="搜索内容或标题" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-paperclip"> </i>标签</div><div class="tagcloud"><a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 20px;">入门</a> <a href="/tags/webpack/" style="font-size: 20px;">webpack</a> <a href="/tags/vue/" style="font-size: 19.5px;">vue</a> <a href="/tags/javascript/" style="font-size: 19px;">javascript</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 18.5px;">翻译</a> <a href="/tags/%E6%B7%B1%E5%85%A5es6/" style="font-size: 18px;">深入es6</a> <a href="/tags/%E5%BA%94%E7%94%A8/" style="font-size: 17.5px;">应用</a> <a href="/tags/vue%E6%BA%90%E7%A0%81/" style="font-size: 17.5px;">vue源码</a> <a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 17.5px;">分析</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 17px;">心理学</a> <a href="/tags/electron/" style="font-size: 17px;">electron</a> <a href="/tags/react/" style="font-size: 16.5px;">react</a> <a href="/tags/haha/" style="font-size: 16px;">haha</a> <a href="/tags/%E4%BA%BA%E6%A0%BC%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 16px;">人格心理学</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E8%A3%85%E9%A5%B0/" style="font-size: 16px;">博客装饰</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" style="font-size: 15.5px;">代码组织</a> <a href="/tags/%E8%B5%84%E6%9C%AC%E8%AE%BA/" style="font-size: 15.5px;">资本论</a> <a href="/tags/angular/" style="font-size: 15px;">angular</a> <a href="/tags/d3/" style="font-size: 15px;">d3</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 15px;">小程序</a> <a href="/tags/ssr/" style="font-size: 15px;">ssr</a> <a href="/tags/nuxt/" style="font-size: 15px;">nuxt</a> <a href="/tags/ae-exp/" style="font-size: 14.5px;">ae exp</a> <a href="/tags/immer/" style="font-size: 14.5px;">immer</a> <a href="/tags/chrome-extension/" style="font-size: 14.5px;">chrome extension</a> <a href="/tags/vite/" style="font-size: 14.5px;">vite</a> <a href="/tags/ci/" style="font-size: 14.5px;">ci</a> <a href="/tags/github-action/" style="font-size: 14.5px;">github action</a> <a href="/tags/monorepo/" style="font-size: 14.5px;">monorepo</a> <a href="/tags/http/" style="font-size: 14.5px;">http</a> <a href="/tags/git/" style="font-size: 14.5px;">git</a> <a href="/tags/%E4%BA%94%E8%A1%8C%E5%85%AB%E5%8D%A6/" style="font-size: 14.5px;">五行八卦</a> <a href="/tags/vuex/" style="font-size: 14.5px;">vuex</a> <a href="/tags/redux/" style="font-size: 14.5px;">redux</a> <a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" style="font-size: 14px;">年终总结</a> <a href="/tags/%E6%91%A9%E6%89%98%E8%BD%A6/" style="font-size: 14px;">摩托车</a> <a href="/tags/chrome-extension/" style="font-size: 14px;">chrome-extension</a> <a href="/tags/vscode/" style="font-size: 14px;">vscode</a> <a href="/tags/%E9%A2%9C%E8%89%B2/" style="font-size: 14px;">颜色</a> <a href="/tags/codemirror/" style="font-size: 14px;">codemirror</a> <a href="/tags/eslint/" style="font-size: 14px;">eslint</a> <a href="/tags/svg/" style="font-size: 14px;">svg</a> <a href="/tags/shortcuts/" style="font-size: 14px;">shortcuts</a> <a href="/tags/web/" style="font-size: 14px;">web</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 14px;">抓包</a> <a href="/tags/hook/" style="font-size: 14px;">hook</a> <a href="/tags/typescript/" style="font-size: 14px;">typescript</a> <a href="/tags/%E9%81%93%E5%BE%B7%E6%83%85%E6%93%8D%E8%AE%BA/" style="font-size: 14px;">道德情操论</a> <a href="/tags/jenkins/" style="font-size: 14px;">jenkins</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 14px;">正则</a> <a href="/tags/%E6%95%B0%E5%AD%A6%E7%9A%84%E9%9B%A8%E4%BC%9E%E4%B8%8B/" style="font-size: 14px;">数学的雨伞下</a> <a href="/tags/esbuild/" style="font-size: 14px;">esbuild</a> <a href="/tags/%E7%9B%B8%E5%AF%B9%E8%AE%BA/" style="font-size: 14px;">相对论</a> <a href="/tags/cordova/" style="font-size: 14px;">cordova</a> <a href="/tags/vite-plugin/" style="font-size: 14px;">vite-plugin</a> <a href="/tags/weex/" style="font-size: 14px;">weex</a> <a href="/tags/%E9%98%BF%E5%BE%B7%E5%8B%92/" style="font-size: 14px;">阿德勒</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-commenting-o"> </i>最近评论</div><div class="epcRecentComments" id="cyReping" role="cylabs" data-use="reping"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> </i>友情链接</div><div class="links"><a href="https://blog.csdn.net/u010416101" title="sean(大数据专家, 人工智能专家)" target="_blank">sean(大数据专家, 人工智能专家)</a><a href="https://blog.csdn.net/u012373815" title="abel(大数据专家, 人工智能专家)" target="_blank">abel(大数据专家, 人工智能专家)</a><a href="https://di1shuai.com/" title="bruce(大数据专家, 人工智能专家)" target="_blank">bruce(大数据专家, 人工智能专家)</a><a href="https://www.cnblogs.com/linxiyue/" title="邓雪(全栈开发专家)" target="_blank">邓雪(全栈开发专家)</a><a href="https://www.xilanhua-c7.top/" title="赵吉(后现代浪漫主义诗人)" target="_blank">赵吉(后现代浪漫主义诗人)</a><a href="https://blog.csdn.net/weixin_40413961" title="98年新栋(首席实习生)" target="_blank">98年新栋(首席实习生)</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">函数式编程介绍</h1><div class="post-meta">Nov 21, 2016<span> | </span><span class="category"><a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 次阅读</span></span></div><div class="post-content"><p>许多函数式编程(以下简称fp for functional programming)文章都说一些抽象的fp技巧. 比如构造(composition), 管道操作(pipelining), 高阶函数(higher order functions). 本文不同. 这里会告诉大家一些平时大家平时每天都要写的命令式的, 非函数式的代码应该如何转换为fp风格的例子.</p>
<p>第一部分将会是把一些遍历处理数据的代码转为<code>map</code>和<code>reduce</code>. 第二部分把比较长的循环打成小块, 并使每个部分函数化. 第三部分会处理一个更大的数据结构并把他写成管道的形式.</p>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>当人们说到fp, 就会去联系到一些特性. 会提到<strong>不可编辑的数据(immutable data)</strong>, <strong>第一类公民(first-class function)</strong>, <strong>尾递归(tail call optimisation)</strong>. 这些是fp的语言特征. 会提到<strong>map</strong>, <strong>reduce</strong>, <strong>管道(pipeling)</strong>, <strong>递归(recursing)</strong>, <strong>柯里化(currying)</strong> 和使用<strong>高阶函数(higher order functions)</strong>. 以上这些是编写fp的技巧. 然后提到了<strong>并行(parallelization)</strong>, <strong>懒求值(lazy evaluation)</strong> 和 <strong>决定性(determinism)</strong>. 这些是fp的优点.</p>
<p>除了这些. fp还有一个特点: 没有<strong>附带作用(side effects)</strong>. fp不依赖方法所在的环境, 也不会改变函数外的变量. 任何变量都可以在函数内获得到. 把以上的东西作为你学习fp的引导思路.</p>
<p>这是一个非函数式的函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">increment1</span>():</span><br><span class="line">    <span class="keyword">global</span> a</span><br><span class="line">    a += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>这是一个函数式函数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">increment2</span>(<span class="params">a</span>):</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="不要对列表遍历-使用map和reduce"><a href="#不要对列表遍历-使用map和reduce" class="headerlink" title="不要对列表遍历. 使用map和reduce"></a>不要对列表遍历. 使用map和reduce</h2><h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>map接受一个函数和一个集合. 然后创建一个新空集合, 在每个集合的元素上运行函数来插入空集合. 最后返回新的集合.</p>
<p>下面是个简单的获取名字长度的map:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name_lengths = <span class="built_in">map</span>(<span class="built_in">len</span>, [<span class="string">&quot;Mary&quot;</span>, <span class="string">&quot;Isla&quot;</span>, <span class="string">&quot;Sam&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> name_lengths</span><br><span class="line"><span class="comment"># =&gt; [4, 4, 3]</span></span><br></pre></td></tr></table></figure>

<p>下面是个返回元素平方的map:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">squares = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x * x, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> squares</span><br><span class="line"><span class="comment"># =&gt; [0, 1, 4, 9, 16]</span></span><br></pre></td></tr></table></figure>

<p>上面的map没有接受一个有名字的函数, 而是一个行内的, 匿名的用lambda定义的函数. lambda函数定义在分号前, 函数体在分号后. 函数体也是lambda函数的返回值.</p>
<p>下面的非fp的代码: 接受真名列表和代名列表, 并随机给真名赋值为代名.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">names = [<span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;Isla&#x27;</span>, <span class="string">&#x27;Sam&#x27;</span>]</span><br><span class="line">code_names = [<span class="string">&#x27;Mr. Pink&#x27;</span>, <span class="string">&#x27;Mr. Orange&#x27;</span>, <span class="string">&#x27;Mr. Blonde&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(names)):</span><br><span class="line">    names[i] = random.choice(code_names)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> names</span><br><span class="line"><span class="comment"># =&gt; [&#x27;Mr. Blonde&#x27;, &#x27;Mr. Blonde&#x27;, &#x27;Mr. Blonde&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>(如你所看到的, 这个算法可以给保密机关的人员分配保密代号. 希望他们不要在执行任务的时候搞错代号.)</p>
<p>上面的代码也可以写成map:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">names = [<span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;Isla&#x27;</span>, <span class="string">&#x27;Sam&#x27;</span>]</span><br><span class="line"></span><br><span class="line">secret_names = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: random.choice([<span class="string">&#x27;Mr. Pink&#x27;</span>,</span><br><span class="line">                                            <span class="string">&#x27;Mr. Orange&#x27;</span>,</span><br><span class="line">                                            <span class="string">&#x27;Mr. Blonde&#x27;</span>]),</span><br><span class="line">                   names)</span><br></pre></td></tr></table></figure>

<p><strong>练习1.</strong> 尝试用map重写以下代码: 这次用更可靠的策略来给特工代号.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">names = [<span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;Isla&#x27;</span>, <span class="string">&#x27;Sam&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(names)):</span><br><span class="line">    names[i] = <span class="built_in">hash</span>(names[i])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> names</span><br><span class="line"><span class="comment"># =&gt; [6306819796133686941, 8135353348168144921, -1228887169324443034]</span></span><br></pre></td></tr></table></figure>

<p>(希望特工都记性不错, 不要在秘密任务中忘记别的同事的代号.)</p>
<p>答案:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">names = [<span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;Isla&#x27;</span>, <span class="string">&#x27;Sam&#x27;</span>]</span><br><span class="line"></span><br><span class="line">secret_names = <span class="built_in">map</span>(<span class="built_in">hash</span>, names)</span><br></pre></td></tr></table></figure>

<h3 id="Reduce"><a href="#Reduce" class="headerlink" title="Reduce"></a>Reduce</h3><p>reduce接受一个函数和一个集合. 他返回的值是混合了输入的值.</p>
<p>下面是一个reduce. 他会返回输入集合的和. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sum</span> = reduce(<span class="keyword">lambda</span> a, x: a + x, [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">sum</span></span><br><span class="line"><span class="comment"># =&gt; 10</span></span><br></pre></td></tr></table></figure>

<p><code>x</code>是当前被遍历到的元素, <code>a</code>是暂存值. 他的值是上次循环lambda函数的返回值. <code>reduce()</code>循环每个元素. 每次都用当前的<code>a</code>和<code>x</code>执行lambda表达式, 把结果赋给下次的<code>a</code>.</p>
<p>那第一次循环<code>a</code>是什么? 第一次没有上一次. <code>reduce()</code>集合的第一个元素作为<code>a</code>的第一次值, 并从集合的第二个元素开始遍历. 也就是说, 第一个<code>x</code>是集合的第二个元素.</p>
<p>下面的代码计算’Sam’出现的次数:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sentences = [<span class="string">&#x27;Mary read a story to Sam and Isla.&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;Isla cuddled Sam.&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;Sam chortled.&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sam_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> sentence <span class="keyword">in</span> sentences:</span><br><span class="line">    sam_count += sentence.count(<span class="string">&#x27;Sam&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> sam_count</span><br><span class="line"><span class="comment"># =&gt; 3</span></span><br></pre></td></tr></table></figure>

<p>reduce版本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sentences = [<span class="string">&#x27;Mary read a story to Sam and Isla.&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;Isla cuddled Sam.&#x27;</span>,</span><br><span class="line">             <span class="string">&#x27;Sam chortled.&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sam_count = reduce(<span class="keyword">lambda</span> a, x: a + x.count(<span class="string">&#x27;Sam&#x27;</span>),</span><br><span class="line">                   sentences,</span><br><span class="line">                   <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>那么怎么解决希望reduce从第一个元素开始? 按照之前的执行, 第一个元素的’Mary read a story to Sam and Isla’中的’Sam’就不会被记入结果了, 我们要在第三个参数传入<code>a</code>的初始值, 这样reduce就会从第一个元素开始了.</p>
<h4 id="为什么map和reduce更好"><a href="#为什么map和reduce更好" class="headerlink" title="为什么map和reduce更好?"></a>为什么map和reduce更好?</h4><p>首先, 他们简化了代码.</p>
<p>第二, 遍历的最重要的部分  — 集合, 他们的操作与返回值不会改变集合的位置.</p>
<p>第三, 循环的代码会影响别的代码, 当然map和reduce是函数式的, 所以不会影响.</p>
<p>第四, map和reduce是元素性的操作. 每次我们操作一个循环, 都需要写几行循环逻辑的代码. 相对的, map和reduce把这些逻辑放进了算法, 代码的可读性也更高. ‘啊, 这个代码是这样这样改变了集合的每个值’.</p>
<p>第五, map和reduce还有一些类似的很实用的封装. 比如: <code>filter</code>, <code>all</code>, <code>any</code>, 和<code>find</code>.</p>
<p><strong>练习2.</strong> 实用map, reduce和filter重写以下代码. filter接受一个函数和一个集合, 返回所有经过函数返回<code>true</code>的元素的集合.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">people = [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;height&#x27;</span>: <span class="number">160</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Isla&#x27;</span>, <span class="string">&#x27;height&#x27;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Sam&#x27;</span>&#125;]</span><br><span class="line"></span><br><span class="line">height_total = <span class="number">0</span></span><br><span class="line">height_count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> people:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;height&#x27;</span> <span class="keyword">in</span> person:</span><br><span class="line">        height_total += person[<span class="string">&#x27;height&#x27;</span>]</span><br><span class="line">        height_count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> height_count &gt; <span class="number">0</span>:</span><br><span class="line">    average_height = height_total / height_count</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> average_height</span><br><span class="line">    <span class="comment"># =&gt; 120</span></span><br></pre></td></tr></table></figure>

<p>如果看起来不好搞, 试试不要考虑数据操作. 思考下数据经过的状态, 从信息列表到平均身高. 不要尝试混合多个操作. 先做一部分, 代码成功了再混合他们.</p>
<p>答案:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">people = [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mary&#x27;</span>, <span class="string">&#x27;height&#x27;</span>: <span class="number">160</span>&#125;,</span><br><span class="line">          &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Isla&#x27;</span>, <span class="string">&#x27;height&#x27;</span>: <span class="number">80</span>&#125;,</span><br><span class="line">          &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Sam&#x27;</span>&#125;]</span><br><span class="line"></span><br><span class="line">heights = <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x[<span class="string">&#x27;height&#x27;</span>],</span><br><span class="line">              <span class="built_in">filter</span>(<span class="keyword">lambda</span> x: <span class="string">&#x27;height&#x27;</span> <span class="keyword">in</span> x, people))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(heights) &gt; <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">from</span> operator <span class="keyword">import</span> add</span><br><span class="line">    average_height = reduce(add, heights) / <span class="built_in">len</span>(heights)</span><br></pre></td></tr></table></figure>

<h2 id="代码要声明式的-而不是命令式的"><a href="#代码要声明式的-而不是命令式的" class="headerlink" title="代码要声明式的, 而不是命令式的"></a>代码要声明式的, 而不是命令式的</h2><p>下面的程序是三台车的比赛. 每个阶段, 每台车都有概率前进, 有概率暂停. 每一步程序都把三台车的进度打出来. 五步以后比赛结束.</p>
<p>下面是样例输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-</span><br><span class="line">- -</span><br><span class="line">- -</span><br><span class="line"></span><br><span class="line">- -</span><br><span class="line">- -</span><br><span class="line">- - -</span><br><span class="line"></span><br><span class="line">- - -</span><br><span class="line">- -</span><br><span class="line">- - -</span><br><span class="line"></span><br><span class="line">- - - -</span><br><span class="line">- - -</span><br><span class="line">- - - -</span><br><span class="line"></span><br><span class="line">- - - -</span><br><span class="line">- - - -</span><br><span class="line">- - - - -</span><br></pre></td></tr></table></figure>

<p>这是代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">time = <span class="number">5</span></span><br><span class="line">car_positions = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> time:</span><br><span class="line">    <span class="comment"># decrease time</span></span><br><span class="line">    time -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(car_positions)):</span><br><span class="line">        <span class="comment"># move car</span></span><br><span class="line">        <span class="keyword">if</span> random() &gt; <span class="number">0.3</span>:</span><br><span class="line">            car_positions[i] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># draw car</span></span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;-&#x27;</span> * car_positions[i]</span><br></pre></td></tr></table></figure>

<p>这段代码是用命令式写的. 函数式版本应该是声明式的. 会声明要做什么, 而不是如何做他.</p>
<h2 id="使用函数式"><a href="#使用函数式" class="headerlink" title="使用函数式"></a>使用函数式</h2><p>程序可以通过拆分方法变得更声明化.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_cars</span>():</span><br><span class="line">    <span class="keyword">for</span> i, _ <span class="keyword">in</span> <span class="built_in">enumerate</span>(car_positions):</span><br><span class="line">        <span class="keyword">if</span> random() &gt; <span class="number">0.3</span>:</span><br><span class="line">            car_positions[i] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_car</span>(<span class="params">car_position</span>):</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;-&#x27;</span> * car_position</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_step_of_race</span>():</span><br><span class="line">    <span class="keyword">global</span> time</span><br><span class="line">    time -= <span class="number">1</span></span><br><span class="line">    move_cars()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw</span>():</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> car_position <span class="keyword">in</span> car_positions:</span><br><span class="line">        draw_car(car_position)</span><br><span class="line"></span><br><span class="line">time = <span class="number">5</span></span><br><span class="line">car_positions = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> time:</span><br><span class="line">    run_step_of_race()</span><br><span class="line">    draw()</span><br></pre></td></tr></table></figure>

<p>想要理解程序, 读者只需要看一下主循环. ‘如果还有次数剩余, 运行比赛的一个阶段并打印, 然后继续检查剩余次数.’ 如果读者想进一步了解是怎么比赛, 怎么画的, 他们可以去对应的函数查看.</p>
<p>这点代码一点都没有注释, 代码是自解释的.</p>
<p>把代码拆分成方法很great, 不太耗脑力又把代码可读性提高. 这种技术使用了函数, 但只是把函数作为子程序使用, 包裹了代码. 从之前的引言来看, 这些代码并不是fp. 上面的代码使用的状态没有通过参数传导. 代码通过改变外部变量来实现. 为了知道方法真正做了什么需要去看外部变量. 如果变量不在, 还要去找变量哪里来的. 还要去查看哪些函数改变了这个变量…</p>
<h2 id="移除状态"><a href="#移除状态" class="headerlink" title="移除状态"></a>移除状态</h2><p>下面才是fp版本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_cars</span>(<span class="params">car_positions</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">map</span>(<span class="keyword">lambda</span> x: x + <span class="number">1</span> <span class="keyword">if</span> random() &gt; <span class="number">0.3</span> <span class="keyword">else</span> x,</span><br><span class="line">               car_positions)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">output_car</span>(<span class="params">car_position</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;-&#x27;</span> * car_position</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_step_of_race</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;time&#x27;</span>: state[<span class="string">&#x27;time&#x27;</span>] - <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;car_positions&#x27;</span>: move_cars(state[<span class="string">&#x27;car_positions&#x27;</span>])&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;\n&#x27;</span>.join(<span class="built_in">map</span>(output_car, state[<span class="string">&#x27;car_positions&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">race</span>(<span class="params">state</span>):</span><br><span class="line">    draw(state)</span><br><span class="line">    <span class="keyword">if</span> state[<span class="string">&#x27;time&#x27;</span>]:</span><br><span class="line">        race(run_step_of_race(state))</span><br><span class="line"></span><br><span class="line">race(&#123;<span class="string">&#x27;time&#x27;</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="string">&#x27;car_positions&#x27;</span>: [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]&#125;)</span><br></pre></td></tr></table></figure>

<p>这些代码依然被分隔成了方法, 但这些方法是函数式的. 有三个特点. 第一, 没有共享的变量了. <code>time</code>和<code>car_positions</code>被直接传入<code>race()</code>.第二, 函数接受了参数. 第三, 没有变量在方法内部被初始化. 所有数据处理完都被作为返回值了. <code>race()</code>递归调用了<code>run_step_of_race()</code>的返回值. 每次运行产生的新状态都会被传入下次的调用中.</p>
<p>现在有2个函数, <code>zero()</code>和<code>one()</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">zero</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&quot;0&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> s[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> s[<span class="number">0</span>] == <span class="string">&quot;1&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> s[<span class="number">1</span>:]</span><br></pre></td></tr></table></figure>

<p><code>zero()</code>接受一个字符串, <code>s</code>. 如果第一个字符是<code>&#39;0&#39;</code>, 就返回剩余的, 如果不是就返回<code>None</code>, python函数的默认返回值.</p>
<p><code>one()</code>方法一样, 但检测的是<code>&#39;1&#39;</code>.</p>
<p>假设一个函数叫做<code>rule_sequence()</code>. 他接受的参数是一个字符串和一系列规则函数类似<code>zero()</code>和<code>one()</code>. 他在字符串上调用第一个规则, 除非返回值是<code>None</code>, 他会继续把返回值调用第二个规则. 除非返回值是<code>None</code>, 他会把返回值作调用第三个规则, 然后第四个… 除非返回了<code>None</code>, <code>rule_sequence()</code>就停止并返回<code>None</code>. 否则, 就返回最后的结果.</p>
<p>以下是一些输入输出:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> rule_sequence(<span class="string">&#x27;0101&#x27;</span>, [zero, one, zero])</span><br><span class="line"><span class="comment"># =&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> rule_sequence(<span class="string">&#x27;0101&#x27;</span>, [zero, zero])</span><br><span class="line"><span class="comment"># =&gt; None</span></span><br></pre></td></tr></table></figure>

<p>下面是<code>rule_sequence()</code>的命令式实现:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rule_sequence</span>(<span class="params">s, rules</span>):</span><br><span class="line">    <span class="keyword">for</span> rule <span class="keyword">in</span> rules:</span><br><span class="line">        s = rule(s)</span><br><span class="line">        <span class="keyword">if</span> s == <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>

<p><strong>练习3.</strong> 上面是循环的实现方式, 用递归来实现:</p>
<p>答案:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rule_sequence</span>(<span class="params">s, rules</span>):</span><br><span class="line">    <span class="keyword">if</span> s == <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> rules:</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> rule_sequence(rules[<span class="number">0</span>](s), rules[<span class="number">1</span>:])</span><br></pre></td></tr></table></figure>

<h2 id="使用管道操作"><a href="#使用管道操作" class="headerlink" title="使用管道操作"></a>使用管道操作</h2><p>在上个章节, 一些命令式的循环被重写为了递归函数. 在这个部分, 另外一个类型的命令式循环会被用一种管道操作的技术重写.</p>
<p>下面的循环作用是: 纠正错误的国家, 纠正错误的拼写及格式.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bands = [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;sunset rubdown&#x27;</span>, <span class="string">&#x27;country&#x27;</span>: <span class="string">&#x27;UK&#x27;</span>, <span class="string">&#x27;active&#x27;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">         &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;women&#x27;</span>, <span class="string">&#x27;country&#x27;</span>: <span class="string">&#x27;Germany&#x27;</span>, <span class="string">&#x27;active&#x27;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">         &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;a silver mt. zion&#x27;</span>, <span class="string">&#x27;country&#x27;</span>: <span class="string">&#x27;Spain&#x27;</span>, <span class="string">&#x27;active&#x27;</span>: <span class="literal">True</span>&#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_bands</span>(<span class="params">bands</span>):</span><br><span class="line">    <span class="keyword">for</span> band <span class="keyword">in</span> bands:</span><br><span class="line">        band[<span class="string">&#x27;country&#x27;</span>] = <span class="string">&#x27;Canada&#x27;</span></span><br><span class="line">        band[<span class="string">&#x27;name&#x27;</span>] = band[<span class="string">&#x27;name&#x27;</span>].replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        band[<span class="string">&#x27;name&#x27;</span>] = band[<span class="string">&#x27;name&#x27;</span>].title()</span><br><span class="line"></span><br><span class="line">format_bands(bands)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> bands</span><br><span class="line"><span class="comment"># =&gt; [&#123;&#x27;name&#x27;: &#x27;Sunset Rubdown&#x27;, &#x27;active&#x27;: False, &#x27;country&#x27;: &#x27;Canada&#x27;&#125;,</span></span><br><span class="line"><span class="comment">#     &#123;&#x27;name&#x27;: &#x27;Women&#x27;, &#x27;active&#x27;: False, &#x27;country&#x27;: &#x27;Canada&#x27; &#125;,</span></span><br><span class="line"><span class="comment">#     &#123;&#x27;name&#x27;: &#x27;A Silver Mt Zion&#x27;, &#x27;active&#x27;: True, &#x27;country&#x27;: &#x27;Canada&#x27;&#125;]</span></span><br></pre></td></tr></table></figure>

<p>问题从函数名字开始, ‘format’太含糊了. 想要仔细查看代码, 这个问题会很严重. 在这个函数里做了3件事: 把<code>country</code>字段的值改为<code>Canada</code>. 把<code>.</code>移除出了band name. 把band name 首字母大写. 这样的函数名很难让人知道他做的什么事, 很难重用, 很难测试, 很难并用.</p>
<p>与下面这个对比下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> pipeline_each(bands, [set_canada_as_country,</span><br><span class="line">                            strip_punctuation_from_name,</span><br><span class="line">                            capitalize_names])</span><br></pre></td></tr></table></figure>

<p>这样的代码很容易看懂. 一下就让人感觉这样的辅助函数是函数式的, 因为他们看起来链在一起. 上一个的输出和下一个的输入是连在一起的. 如果函数是函数式的, 就很容易被验证. 也很容易被重用, 测试, 和并用.</p>
<p><code>pipeline_each()</code>是使用传入的类似<code>set_canada_as_country()</code>的辅助函数(每次一个)来改变bands. 当辅助函数被应用到了所有bands上, <code>pileline_each()</code>把结果传到下一个函数中. </p>
<p>我们来看看这些辅助函数.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">assoc</span>(<span class="params">_d, key, value</span>):</span><br><span class="line">    <span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy</span><br><span class="line">    d = deepcopy(_d)</span><br><span class="line">    d[key] = value</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_canada_as_country</span>(<span class="params">band</span>):</span><br><span class="line">    <span class="keyword">return</span> assoc(band, <span class="string">&#x27;country&#x27;</span>, <span class="string">&quot;Canada&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">strip_punctuation_from_name</span>(<span class="params">band</span>):</span><br><span class="line">    <span class="keyword">return</span> assoc(band, <span class="string">&#x27;name&#x27;</span>, band[<span class="string">&#x27;name&#x27;</span>].replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">capitalize_names</span>(<span class="params">band</span>):</span><br><span class="line">    <span class="keyword">return</span> assoc(band, <span class="string">&#x27;name&#x27;</span>, band[<span class="string">&#x27;name&#x27;</span>].title())</span><br></pre></td></tr></table></figure>

<p>每个都关联了band上的一个键并给了新值. 没有简单的办法可以不改变原来band的值, 所以<code>assoc()</code>使用了<code>deepcopy()</code>来解决问题. 每个辅助函数改变了一份副本并返回这份副本.</p>
<p>看起来一切正常. band的原始值也没有被修改. 但有2处潜在的修改问题. 在<code>strip_punctuation_from_name()</code>里, 没有带<code>.</code>的名字因为在原始值上调用了<code>replace()</code>而生成, 大写化的名字也因为调用了<code>capitalize_names()</code>而生成. 如果<code>replace()</code>和<code>title()</code>是非函数式的, 那么<code>strip_punctuation_from_name()</code>和<code>capitalize_names()</code>也不是函数式的了.</p>
<p>幸运的是, <code>replace()</code>和<code>title()</code>不会修改他们操作的元素. 这是因为字符串在python中是不可修改的. 也就是说<code>replace()</code>操作元素的时候新建了一份副本并在副本上操作.</p>
<p>python是像Clojure一样的语言, 程序员不需要考虑他们是否改变数据, 这些语言永远不会.</p>
<p><strong>练习4.</strong> 试着写出<code>pipeline_each</code>方法. 思考一下操作的顺序. 输入的元素, 一次一个元素, 给第一个辅助函数操作. 然后传递给之后的辅助函数.</p>
<p>答案:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pipeline_each</span>(<span class="params">data, fns</span>):</span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> a, x: <span class="built_in">map</span>(x, a),</span><br><span class="line">                  fns,</span><br><span class="line">                  data)</span><br></pre></td></tr></table></figure>

<p>三个辅助方法都有重复的代码. 我们可以用<code>call()</code>方法来抽象他.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set_canada_as_country = call(<span class="keyword">lambda</span> x: <span class="string">&#x27;Canada&#x27;</span>, <span class="string">&#x27;country&#x27;</span>)</span><br><span class="line">strip_punctuation_from_name = call(<span class="keyword">lambda</span> x: x.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">capitalize_names = call(<span class="built_in">str</span>.title, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> pipeline_each(bands, [set_canada_as_country,</span><br><span class="line">                            strip_punctuation_from_name,</span><br><span class="line">                            capitalize_names])</span><br></pre></td></tr></table></figure>

<p>如果我们为了简洁而牺牲些可读性:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> pipeline_each(bands, [call(<span class="keyword">lambda</span> x: <span class="string">&#x27;Canada&#x27;</span>, <span class="string">&#x27;country&#x27;</span>),</span><br><span class="line">                            call(<span class="keyword">lambda</span> x: x.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                            call(<span class="built_in">str</span>.title, <span class="string">&#x27;name&#x27;</span>)])</span><br></pre></td></tr></table></figure>

<p><code>call()</code>的代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">assoc</span>(<span class="params">_d, key, value</span>):</span><br><span class="line">    <span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy</span><br><span class="line">    d = deepcopy(_d)</span><br><span class="line">    d[key] = value</span><br><span class="line">    <span class="keyword">return</span> d</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">fn, key</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">apply_fn</span>(<span class="params">record</span>):</span><br><span class="line">        <span class="keyword">return</span> assoc(record, key, fn(record.get(key)))</span><br><span class="line">    <span class="keyword">return</span> apply_fn</span><br></pre></td></tr></table></figure>

<p><strong>这里发生了很多, 让我们一点点地看.</strong></p>
<p>第一. <code>call()</code>是个高阶函数. 高阶函数接受函数为参数或者返回一个函数. 或者像<code>call()</code>一样, 两者都有.</p>
<p>第二. <code>apply_fn()</code>看起来很像那3个辅助函数. 他接受record(就是band). 他找到<code>record[key]</code>并用<code>fn</code>调用它. 最后返回一份结果的副本.</p>
<p>第三. <code>call()</code>方法实际没有做任何工作. 调用以后是<code>apply_fn()</code>来工作的. 在<code>pipeline_each()</code>中, 一个<code>apply_fn()</code>的实例会讲<code>country</code>设置为<code>Canada</code>. 另一个实例会把名字首字母大写.</p>
<p>第四. 当<code>apply_fn()</code>运行了, <code>fn</code>和<code>key</code>不在作用域中. 他们都是<code>apply_fn()</code>的参数, 也不是本地变量. 但仍可以被获取到. 当函数被定义, 会把引用当做变量存在自己的作用域里: 无论在方法内还是方法外的变量. 当函数运行, 他的代码引用了变量, python查找在参数中的变量. 如果找不到, 会去找保存过的引用. 这就是为什么可以找到<code>fn</code>和<code>key</code>.</p>
<p>第五. 在<code>call()</code>方法中没有涉及到bands. 因为<code>call()</code>方法是用来生成管道操作的, 不关心操作的内容. fp从某个程度上来说是构造一个普遍的, 可复用的, 组件化的函数.</p>
<p>好. 闭包, 高阶函数, 和变量作用域都在上面的例子说好了. 让我们喝杯柠檬水吧.</p>
<hr>
<p>我们还有一个band需要处理的东西. 就是移除除了name和contry的所有字段. <code>extract_name_and_contry()</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">extract_name_and_country</span>(<span class="params">band</span>):</span><br><span class="line">    plucked_band = &#123;&#125;</span><br><span class="line">    plucked_band[<span class="string">&#x27;name&#x27;</span>] = band[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    plucked_band[<span class="string">&#x27;country&#x27;</span>] = band[<span class="string">&#x27;country&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> plucked_band</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> pipeline_each(bands, [call(<span class="keyword">lambda</span> x: <span class="string">&#x27;Canada&#x27;</span>, <span class="string">&#x27;country&#x27;</span>),</span><br><span class="line">                            call(<span class="keyword">lambda</span> x: x.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                            call(<span class="built_in">str</span>.title, <span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                            extract_name_and_country])</span><br><span class="line"></span><br><span class="line"><span class="comment"># =&gt; [&#123;&#x27;name&#x27;: &#x27;Sunset Rubdown&#x27;, &#x27;country&#x27;: &#x27;Canada&#x27;&#125;,</span></span><br><span class="line"><span class="comment">#     &#123;&#x27;name&#x27;: &#x27;Women&#x27;, &#x27;country&#x27;: &#x27;Canada&#x27;&#125;,</span></span><br><span class="line"><span class="comment">#     &#123;&#x27;name&#x27;: &#x27;A Silver Mt Zion&#x27;, &#x27;country&#x27;: &#x27;Canada&#x27;&#125;]</span></span><br></pre></td></tr></table></figure>

<p><code>extract_name_and_country()</code>可以用<code>pluck()</code>写成一个普通的函数.</p>
<p><code>pluck()</code>的作用是:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> pipeline_each(bands, [call(<span class="keyword">lambda</span> x: <span class="string">&#x27;Canada&#x27;</span>, <span class="string">&#x27;country&#x27;</span>),</span><br><span class="line">                            call(<span class="keyword">lambda</span> x: x.replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                            call(<span class="built_in">str</span>.title, <span class="string">&#x27;name&#x27;</span>),</span><br><span class="line">                            pluck([<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;country&#x27;</span>])])</span><br></pre></td></tr></table></figure>

<p><strong>练习5.</strong>  <code>pluck()</code> 接受一个键的数组, 然后把键从集合中去掉. 试着写一下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pluck</span>(<span class="params">keys</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pluck_fn</span>(<span class="params">record</span>):</span><br><span class="line">        <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> a, x: assoc(a, x, record[x]),</span><br><span class="line">                      keys,</span><br><span class="line">                      &#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span> pluck_fn</span><br></pre></td></tr></table></figure>

<hr>
<p><a target="_blank" rel="noopener" href="https://codewords.recurse.com/issues/one/an-introduction-to-functional-programming">原文地址</a> <em>顺带一提: 本文的章节号很乱, 出于尊重原文(lan)的原因没有改</em></p>
</div><div class="post-footer"></div><p> (本文完)</p><p> 如果你觉得本文对你有帮助, 你可以<a href="/about/give-me-a-coffee.html">请我喝一杯咖啡</a></p><p> 本文遵循<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">cc协议</a></p><p> 你可以在注明出处和非商用的前提下任意复制及演绎</p><div class="post-footer"></div><div class="tags"><a href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/">代码组织</a><a href="/tags/%E7%BF%BB%E8%AF%91/">翻译</a><a href="/tags/%E5%85%A5%E9%97%A8/">入门</a></div><div class="post-nav"><a class="pre" href="/2016/12/02/stage-3-rest-spread-transform/">stage-3 rest函数和解构赋值</a><a class="next" href="/2016/11/13/stage-3-async-await/">体验stage-3 async/await</a></div><div id="SOHUCS"></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><p>©&nbsp;<a href="/." rel="nofollow">EL PSY CONGROO. </a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/">沪ICP备16053193号-2</a></p><p>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> | Designed by hahahaha</p></div></div></div></div><script>document.body.className = localStorage.getItem('yo-cwj-theme') || 't1'
</script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="https://cy-cdn.kuaizhan.com/js/??lib/jquery.js,changyan.labs.https.js?appid=cyt1bgEED" async></script><script>(function () {
    var appid = 'cyt1bgEED';
    var conf = 'prod_20e8d05c4d6b3ce62b89be98ae18390c';
    var width = window.innerWidth || document.documentElement.clientWidth;
    if (width < 960) {
        var head = document.getElementsByTagName('head')[0]||document.head||document.documentElement;
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.charset = 'utf-8';
        script.id = 'changyan_mobile_js';
        script.src = 'https://cy-cdn.kuaizhan.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
        head.appendChild(script);
    } else {
        var loadJs=function(d,a){
        var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;
        var b=document.createElement("script");
        b.setAttribute("type","text/javascript");
        b.setAttribute("charset","UTF-8");b.setAttribute("src",d);
        if(typeof a==="function"){
          if(window.attachEvent){
            b.onreadystatechange=function(){
              var e=b.readyState;
              if(e==="loaded"||e==="complete"){
                b.onreadystatechange=null;
                a();
              }
            }
            }else{
              b.onload=a
            }
          }
          c.appendChild(b)
        };
      loadJs("https://cy-cdn.kuaizhan.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})});
    }
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></html>