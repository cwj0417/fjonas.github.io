<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="chen wen jun's blog"><meta name="baidu-site-verification" content="no5dkv1A7T"><title>nuxt流程介绍 | EL PSY CONGROO</title><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="/js/main.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css"><script type="text/javascript" src="/js/post.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body></body><div id="header"><div class="body_container"><div id="nav-menu"><a class="current" href="/."> 主页</a><a href="/archives/"> 归档</a><a target="_blank" rel="noopener" href="https://next.yo-cwj.com"> 项目</a><a href="/about/"> 关于</a></div><div class="site-name"><img class="avatar" src="/./img/avatar.png"><div class="theme-selector"><div class="selector" onclick="document.body.className = 't1';localStorage.setItem('yo-cwj-theme', 't1')" style="background: #00c7ff;"></div><div class="selector" onclick="document.body.className = 't2';localStorage.setItem('yo-cwj-theme', 't2')" style="background: #ffe100;"></div><div class="selector" onclick="document.body.className = 't3';localStorage.setItem('yo-cwj-theme', 't3')" style="background: #55ff00;"></div></div><br><h1 class="hidden">nuxt流程介绍</h1><a id="logo" href="/.">EL PSY CONGROO</a><p class="description">陈文俊的博客</p><p class="links"><a target="_blank" rel="noopener" href="https://segmentfault.com/u/xpang"><img src="/./img/sf.ico"></a><a target="_blank" rel="noopener" href="https://github.com/cwj0417"><img src="/./img/github.png"></a><a target="_blank" rel="noopener" href="https://dribbble.com/fjonas"><img src="/./img/dribbble.ico"></a><a target="_blank" rel="noopener" href="https://weibo.com/2719310113"><img src="/./img/weibo.ico"></a></p></div></div></div><div class="body_container"><div class="pure-g" id="layout"><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="搜索内容或标题" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-paperclip"> </i>标签</div><div class="tagcloud"><a href="/tags/webpack/" style="font-size: 20px;">webpack</a> <a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 20px;">入门</a> <a href="/tags/vue/" style="font-size: 19.57px;">vue</a> <a href="/tags/javascript/" style="font-size: 19.14px;">javascript</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 18.71px;">翻译</a> <a href="/tags/%E6%B7%B1%E5%85%A5es6/" style="font-size: 18.29px;">深入es6</a> <a href="/tags/vue%E6%BA%90%E7%A0%81/" style="font-size: 17.86px;">vue源码</a> <a href="/tags/%E5%BA%94%E7%94%A8/" style="font-size: 17.43px;">应用</a> <a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 17.43px;">分析</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 17px;">心理学</a> <a href="/tags/electron/" style="font-size: 17px;">electron</a> <a href="/tags/react/" style="font-size: 16.57px;">react</a> <a href="/tags/haha/" style="font-size: 16.14px;">haha</a> <a href="/tags/%E4%BA%BA%E6%A0%BC%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 15.71px;">人格心理学</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E8%A3%85%E9%A5%B0/" style="font-size: 15.71px;">博客装饰</a> <a href="/tags/%E8%A7%A3%E9%87%8A%E8%84%91/" style="font-size: 15.29px;">解释脑</a> <a href="/tags/%E8%B5%84%E6%9C%AC%E8%AE%BA/" style="font-size: 15.29px;">资本论</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" style="font-size: 15.29px;">代码组织</a> <a href="/tags/angular/" style="font-size: 14.86px;">angular</a> <a href="/tags/d3/" style="font-size: 14.86px;">d3</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 14.86px;">小程序</a> <a href="/tags/hama/" style="font-size: 14.86px;">hama</a> <a href="/tags/ssr/" style="font-size: 14.86px;">ssr</a> <a href="/tags/nuxt/" style="font-size: 14.86px;">nuxt</a> <a href="/tags/ae-exp/" style="font-size: 14.43px;">ae exp</a> <a href="/tags/immer/" style="font-size: 14.43px;">immer</a> <a href="/tags/chrome-extension/" style="font-size: 14.43px;">chrome extension</a> <a href="/tags/codemirror/" style="font-size: 14.43px;">codemirror</a> <a href="/tags/vite/" style="font-size: 14.43px;">vite</a> <a href="/tags/ci/" style="font-size: 14.43px;">ci</a> <a href="/tags/github-action/" style="font-size: 14.43px;">github action</a> <a href="/tags/monorepo/" style="font-size: 14.43px;">monorepo</a> <a href="/tags/http/" style="font-size: 14.43px;">http</a> <a href="/tags/git/" style="font-size: 14.43px;">git</a> <a href="/tags/%E4%BA%94%E8%A1%8C%E5%85%AB%E5%8D%A6/" style="font-size: 14.43px;">五行八卦</a> <a href="/tags/vuex/" style="font-size: 14.43px;">vuex</a> <a href="/tags/redux/" style="font-size: 14.43px;">redux</a> <a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" style="font-size: 14px;">年终总结</a> <a href="/tags/%E6%91%A9%E6%89%98%E8%BD%A6/" style="font-size: 14px;">摩托车</a> <a href="/tags/chrome-extension/" style="font-size: 14px;">chrome-extension</a> <a href="/tags/vscode/" style="font-size: 14px;">vscode</a> <a href="/tags/%E9%A2%9C%E8%89%B2/" style="font-size: 14px;">颜色</a> <a href="/tags/eslint/" style="font-size: 14px;">eslint</a> <a href="/tags/svg/" style="font-size: 14px;">svg</a> <a href="/tags/shortcuts/" style="font-size: 14px;">shortcuts</a> <a href="/tags/web/" style="font-size: 14px;">web</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 14px;">抓包</a> <a href="/tags/hook/" style="font-size: 14px;">hook</a> <a href="/tags/typescript/" style="font-size: 14px;">typescript</a> <a href="/tags/%E9%81%93%E5%BE%B7%E6%83%85%E6%93%8D%E8%AE%BA/" style="font-size: 14px;">道德情操论</a> <a href="/tags/jenkins/" style="font-size: 14px;">jenkins</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 14px;">正则</a> <a href="/tags/%E6%95%B0%E5%AD%A6%E7%9A%84%E9%9B%A8%E4%BC%9E%E4%B8%8B/" style="font-size: 14px;">数学的雨伞下</a> <a href="/tags/esbuild/" style="font-size: 14px;">esbuild</a> <a href="/tags/%E7%9B%B8%E5%AF%B9%E8%AE%BA/" style="font-size: 14px;">相对论</a> <a href="/tags/cordova/" style="font-size: 14px;">cordova</a> <a href="/tags/vite-plugin/" style="font-size: 14px;">vite-plugin</a> <a href="/tags/weex/" style="font-size: 14px;">weex</a> <a href="/tags/%E9%98%BF%E5%BE%B7%E5%8B%92/" style="font-size: 14px;">阿德勒</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-commenting-o"> </i>最近评论</div><div class="epcRecentComments" id="cyReping" role="cylabs" data-use="reping"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> </i>友情链接</div><div class="links"><a href="https://blog.csdn.net/u010416101" title="sean(大数据专家, 人工智能专家)" target="_blank">sean(大数据专家, 人工智能专家)</a><a href="https://blog.csdn.net/u012373815" title="abel(大数据专家, 人工智能专家)" target="_blank">abel(大数据专家, 人工智能专家)</a><a href="https://di1shuai.com/" title="bruce(大数据专家, 人工智能专家)" target="_blank">bruce(大数据专家, 人工智能专家)</a><a href="https://www.cnblogs.com/linxiyue/" title="邓雪(全栈开发专家)" target="_blank">邓雪(全栈开发专家)</a><a href="https://www.xilanhua-c7.top/" title="赵吉(后现代浪漫主义诗人)" target="_blank">赵吉(后现代浪漫主义诗人)</a><a href="https://blog.csdn.net/weixin_40413961" title="98年新栋(首席实习生)" target="_blank">98年新栋(首席实习生)</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">nuxt流程介绍</h1><div class="post-meta">Jun 24, 2024<span> | </span><span class="category"><a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 次阅读</span></span></div><div class="post-content"><p>在上次写了 vue ssr 简单例子后, 就好奇如何处理 sfc 的情况.</p>
<p>期望的脚本应该能处理 server 端和 client 端的 sfc, 并且可以 hmr. </p>
<p>觉得以自己的水平完全没有思路, 于是了解了下 nuxt 的流程.</p>
<span id="more"></span>

<p>nuxt 在此外, 还有非常多功能, 这里我先关注是如何同时处理 server 端和 client 端的.</p>
<p>这里以<code>nuxt dev</code>的流程为材料, 分析 server 的层级. 也会在第二部分指一下具体是哪些文件与方法.</p>
<h2 id="server-层级"><a href="#server-层级" class="headerlink" title="server 层级"></a>server 层级</h2><p>server 的层级就对应着每个请求的 callstack. </p>
<p>请求是分为很多种的: 比如请求根页面(‘&#x2F;‘), 或者路由, 应该会走到服务器渲染. 引入的 script 和 hmr 应该要走到 client 的 compiler.</p>
<p>server 有多层, 可以整合多个服务(server render, client dev, server api等), 还可以更灵活配置以及提高开发体验.</p>
<ol>
<li><p>dev server.</p>
<p>最外层的 server, 我们浏览器打开的端口是这层 server 监听的.</p>
<p>负责转发请求给下一层 server, 并在其他部分没有准备好的时候返回一个”空页面模板”, 让页面能立即响应.</p>
</li>
<li><p>nuxt dev server.</p>
<p>在这层 nuxt dev server (后文简称 nds) 除了会监听端口, 并通知上层 server 以便代理到 nds. </p>
<p>nds 还有个主要任务, 是创建 nitro, 并启动server render和 client 的构建, 让这 server render 和 client 的构建结果与 nitro 关联.</p>
</li>
<li><p>intro.</p>
<p>在 nds 执行后会创建 nitro, 并把请求代理指给 nitro, 让 nitro 负责请求的最后分发.</p>
</li>
</ol>
<p><strong>从请求的角度来看, 请求最终都会进入 nitro 被分发, server render 的请求会被转发到一个 worker, client 的请求会被转发到 vite server</strong>.</p>
<h2 id="深入一些流程"><a href="#深入一些流程" class="headerlink" title="深入一些流程"></a>深入一些流程</h2><p>上面章节的内容已经总结得不错了, 这个部分会比较难以阅读, 但读完会更准确理解一些细节.</p>
<p>我会从<code>nuxt dev</code>命令开始, 直到请求到达 worker &#x2F; vite. 也会写明代码是出自于什么 repo 和什么文件.</p>
<h3 id="从-cli-到文件"><a href="#从-cli-到文件" class="headerlink" title="从 cli 到文件"></a>从 cli 到文件</h3><p>我们可以从 node_modules 里看到, <code>nuxt dev</code>命令跑的是<code>nuxi</code>提供的.</p>
<p>来到<code>nuxi</code>的<code>src/run.ts</code>, 可以看到他用<code>citty</code>的<code>runMain</code>跑了一段配置, 这段配置加载了<code>src/commands</code>文件夹下的命令, 我们执行的命令自然就是<code>src/commands/dev.ts</code>了.</p>
<p>命令都会先运行<code>setup()</code>再运行<code>run()</code>. 下面我们来看<code>dev</code>命令.</p>
<h3 id="dev命令"><a href="#dev命令" class="headerlink" title="dev命令"></a>dev命令</h3><p>dev命令主要做了2个事: <strong>起 dev server 监听端口, 起个子进程, 调用<code>_dev</code>命令, 并与他建立通信关系</strong>.</p>
<p>在<code>dev.ts</code>的<code>run()</code>方法里, 读取一些配置后, 我们的执行会走到这个分支:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ctx.<span class="property">args</span>.<span class="property">fork</span>) &#123;</span><br><span class="line">    <span class="comment">// Fork Nuxt dev process</span></span><br><span class="line">    <span class="keyword">const</span> devProxy = <span class="keyword">await</span> <span class="title function_">_createDevProxy</span>(nuxtOptions, listenOptions) <span class="comment">// 起 dev server, 监听端口</span></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">_startSubprocess</span>(devProxy, ctx.<span class="property">rawArgs</span>) <span class="comment">// 起子进程</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">listener</span>: devProxy?.<span class="property">listener</span> &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>我们分别来看这2个方法.</p>
<p>在<code>createDevProxy()</code>中:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"><span class="attr">req</span>: <span class="title class_">IncomingMessage</span>, <span class="attr">res</span>: <span class="title class_">ServerResponse</span></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!address) &#123;</span><br><span class="line">    res.<span class="property">statusCode</span> = <span class="number">503</span></span><br><span class="line">    res.<span class="title function_">setHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/html&#x27;</span>)</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="title function_">loadingTemplate</span>(&#123; <span class="attr">loading</span>: loadingMessage &#125;))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> proxy.<span class="title function_">web</span>(req, res, &#123; <span class="attr">target</span>: address &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 server 的 handler, 判断是否有<code>address</code>变量, 如果没有则返回一个”空页面”模板, 如果有, 则把请求代理到 <code>address</code>.</p>
<p><code>address</code>是通过向外抛了个<code>setAddress()</code>方法来设置<code>address</code>.</p>
<p>接下来看<code>_startSubprocess()</code>里调用<code>setAddress()</code>的地方.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Listen for IPC messages</span></span><br><span class="line">childProc.<span class="title function_">on</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params"><span class="attr">message</span>: <span class="title class_">NuxtDevIPCMessage</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (message.<span class="property">type</span> === <span class="string">&#x27;nuxt:internal:dev:ready&#x27;</span>) &#123;</span><br><span class="line">    devProxy.<span class="title function_">setAddress</span>(<span class="string">`http://127.0.0.1:<span class="subst">$&#123;message.port&#125;</span>`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="property">type</span> === <span class="string">&#x27;nuxt:internal:dev:loading&#x27;</span>) &#123;</span><br><span class="line">    devProxy.<span class="title function_">setAddress</span>(<span class="literal">undefined</span>)</span><br><span class="line">    devProxy.<span class="title function_">setLoadingMessage</span>(message.<span class="property">message</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (message.<span class="property">type</span> === <span class="string">&#x27;nuxt:internal:dev:restart&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">restart</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>子进程在接受到<code>nuxt:internal:dev:ready</code>的时候会设置<code>address</code>.</p>
<p>设置这个<code>address</code>变量不光是因为子进程监听的端口不固定, 更重要的是通知这层 server, 下层的东西都准备好了, 在准备好之前现在这层 server 都会返回一个”空页面”的模板.</p>
<h3 id="nuxt-dev-server"><a href="#nuxt-dev-server" class="headerlink" title="nuxt dev server"></a>nuxt dev server</h3><p>来到子进程<code>_dev</code>的命令: <code>dev-child.ts</code>. 这个命令主要是创建了<code>NuxtDevServer</code>, 后面会简称 nds.</p>
<h4 id="与父进程建立联系"><a href="#与父进程建立联系" class="headerlink" title="与父进程建立联系"></a>与父进程建立联系</h4><p>可以看到创建完 nds 后, 在 nds 收到<code>ready</code>事件后, 向父进程发出<code>nuxt:internal:dev:ready</code>事件来设置<code>address</code>, 以完成和上一章节 dev server 的联系.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Init Nuxt dev</span></span><br><span class="line"><span class="keyword">const</span> nuxtDev = <span class="keyword">await</span> <span class="title function_">createNuxtDevServer</span>(&#123;</span><br><span class="line">  <span class="comment">// 省略一些参数</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// IPC Hooks</span></span><br><span class="line"><span class="keyword">function</span> sendIPCMessage&lt;T <span class="keyword">extends</span> <span class="title class_">NuxtDevIPCMessage</span>&gt;(<span class="attr">message</span>: T) &#123;</span><br><span class="line">  process.<span class="title function_">send</span>(message)</span><br><span class="line">&#125;</span><br><span class="line">nuxtDev.<span class="title function_">on</span>(<span class="string">&#x27;ready&#x27;</span>, <span class="function">(<span class="params">payload</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">sendIPCMessage</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;nuxt:internal:dev:ready&#x27;</span>, <span class="attr">port</span>: payload.<span class="property">port</span> &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init server</span></span><br><span class="line"><span class="keyword">await</span> nuxtDev.<span class="title function_">init</span>()</span><br></pre></td></tr></table></figure>

<p><code>createNuxtDevServer</code>做的事情很简单. <strong>监听端口, 创建 nds, 并把端口的 handler 交给 nds</strong>.</p>
<p>nds 在构造方法中是这样处理 handler 的:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">handler</span> = <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> _initPromise</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_handler</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_handler</span>(req, res)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_renderError</span>(res)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到和之前的<code>address</code>和<code>setAddress</code>非常像了.</p>
<p>这个<code>_handler</code>一开始是空值, 是在即将要展开的<code>nuxtDev.init()</code>中被赋值的, 我们优先看一下赋值的片段.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">init</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 省略一些代码</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_handler</span> = <span class="title function_">toNodeListener</span>(<span class="variable language_">this</span>.<span class="property">_currentNuxt</span>.<span class="property">server</span>.<span class="property">app</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;ready&#x27;</span>, addr)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 nds 的 <code>init()</code>的最后, 设置了<code>_handler</code>, 并抛出了<code>ready</code>事件, 才调用了上层的<code>setAdress()</code>. 所以请求如果可以被分发到 nds 监听的端口, <code>_handler</code>一定是存在的了. 如果不存在, 确实可以报异常了.</p>
<h4 id="nds-init"><a href="#nds-init" class="headerlink" title="nds init"></a>nds init</h4><p>到现在, 我们知道了, 请求最后都会走到<code>this._handler = toNodeListener(this._currentNuxt.server.app)</code>.</p>
<p>那么<code>this._currentNuxt.server.app</code>是如何建立, 如何处理请求, 都在<code>init()</code>方法里.</p>
<p>代码在<code>nuxi</code>的<code>src/utils/dev.ts</code>中.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">load</span>()</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_watchConfig</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">load</span>(<span class="params"><span class="attr">reload</span>?: <span class="built_in">boolean</span>, <span class="attr">reason</span>?: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_load</span>(reload, reason)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>init()</code>方法其实是调用<code>_load()</code>方法.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">_load</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 只摘取了这个代码我们关心的部分代码</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> kit = <span class="keyword">await</span> <span class="title function_">loadKit</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">cwd</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_currentNuxt</span> = <span class="keyword">await</span> kit.<span class="title function_">loadNuxt</span>(&#123; <span class="comment">/*省略一些参数*/</span> &#125;)</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">_currentNuxt</span>.<span class="title function_">ready</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    kit.<span class="title function_">writeTypes</span>(<span class="variable language_">this</span>.<span class="property">_currentNuxt</span>).<span class="title function_">catch</span>(<span class="variable language_">console</span>.<span class="property">error</span>),</span><br><span class="line">    kit.<span class="title function_">buildNuxt</span>(<span class="variable language_">this</span>.<span class="property">_currentNuxt</span>),</span><br><span class="line">  ])</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_handler</span> = <span class="title function_">toNodeListener</span>(<span class="variable language_">this</span>.<span class="property">_currentNuxt</span>.<span class="property">server</span>.<span class="property">app</span>)</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;ready&#x27;</span>, addr)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我摘取了我们关心的代码, 并用空行分为了四个部分:</p>
<ol>
<li>根据配置读取 nuxt, 这里的<code>kit</code>其实就是通过 npm 读取了<code>nuxt</code>. 后面所有的 “kit.xxx” 的代码都是在 nuxt 仓库里的.</li>
<li>创建 nuxt 实例并执行<code>ready()</code>. 这里其实是创建了 intro, 是处理请求的地方, 也就是上面的<code>this._currentNuxt.server</code>. </li>
<li><code>kit.buildNuxt()</code>. 在这里进行了 server render 和 client 的构建, 再通过一些方式与上一步的 intro 进行关联, 最后处理请求.</li>
<li>设置<code>_handler</code>并上报<code>ready</code>事件, 这个前面的章节已经说了.</li>
</ol>
<p>那么接下来让我们继续看看 nitro 的创建, server render 与 client 的构建, 以及他们是如何进行关联的.</p>
<h4 id="nitro"><a href="#nitro" class="headerlink" title="nitro"></a>nitro</h4><p>nitro 的创建来自于上个章节的”第一部分”, <code>kit.loadNuxt()</code>.</p>
<p>上面也说到, 这里的<code>kit</code>就是指 nuxt, 方法在 nuxt 仓库里的<code>src/core/nuxt.ts</code>中.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">loadNuxt</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 省略一些代码</span></span><br><span class="line">  <span class="keyword">const</span> nuxt = <span class="title function_">createNuxt</span>(options)</span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">ready</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> nuxt.<span class="title function_">ready</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createNuxt()</code>方法非常简单, nuxt 是一个简单的对象, 下面的代码只省略了几行:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createNuxt</span> (<span class="params"><span class="attr">options</span>: <span class="title class_">NuxtOptions</span></span>): <span class="title class_">Nuxt</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> hooks = createHooks&lt;<span class="title class_">NuxtHooks</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">nuxt</span>: <span class="title class_">Nuxt</span> = &#123;</span><br><span class="line">    hooks,</span><br><span class="line">    <span class="attr">callHook</span>: hooks.<span class="property">callHook</span>,</span><br><span class="line">    <span class="attr">addHooks</span>: hooks.<span class="property">addHooks</span>,</span><br><span class="line">    <span class="attr">hook</span>: hooks.<span class="property">hook</span>,</span><br><span class="line">    <span class="attr">ready</span>: <span class="function">() =&gt;</span> <span class="title function_">initNuxt</span>(nuxt),</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> nuxt</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>nuxt.ready()</code> 就是 <code>initNuxt()</code>.</p>
<p><code>initNuxt()</code>方法很长, 做了很多”增加组件, 增加插件, 增加选项”的事. 而我们关心的是这个方法: <code>await initNitro(nuxt)</code>.</p>
<p>下面是我们关心的代码:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">initNitro</span>(<span class="params"><span class="attr">nuxt</span>: <span class="title class_">Nuxt</span> &amp; &#123; _nitro?: Nitro &#125;</span>) &#123;</span><br><span class="line">  <span class="comment">// 省略了这个方法的比较多代码</span></span><br><span class="line">  <span class="comment">// Init nitro</span></span><br><span class="line">  <span class="keyword">const</span> nitro = <span class="keyword">await</span> <span class="title function_">createNitro</span>(nitroConfig)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Expose nitro to modules and kit</span></span><br><span class="line">  nuxt.<span class="property">_nitro</span> = nitro</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> devMiddlewareHandler = <span class="title function_">dynamicEventHandler</span>()</span><br><span class="line">  nitro.<span class="property">options</span>.<span class="property">devHandlers</span>.<span class="title function_">unshift</span>(&#123; <span class="attr">handler</span>: devMiddlewareHandler &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// nuxt dev</span></span><br><span class="line">  <span class="keyword">if</span> (nuxt.<span class="property">options</span>.<span class="property">dev</span>) &#123;</span><br><span class="line">    nuxt.<span class="title function_">hook</span>(<span class="string">&#x27;server:devHandler&#x27;</span>, <span class="function">(<span class="params">h</span>) =&gt;</span> &#123; devMiddlewareHandler.<span class="title function_">set</span>(h) &#125;)</span><br><span class="line">    nuxt.<span class="property">server</span> = <span class="title function_">createDevServer</span>(nitro)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createNitro()</code>和之前创建 nuxt 类似, 只是创建了个对象, 然后挂到 nuxt 上.</p>
<p>这里创建了个<code>devMiddlewareHandler</code>给<code>nitro.options.devHandlers</code>, 并可以通过<code>server:devHandler</code>事件来增加 handler, 来配合 vite 使用, 后面会展开.</p>
<p>再看<code>createDevServer(nitro)</code>, 他的返回结果被赋值给了<code>nuxt.server</code>. 上文提到, 请求最后被代理到<code>nuxt.server.app</code>, 就是指这个了.</p>
<p>app 是从 <code>h3</code> 引入来的, 使用了<code>app.use</code>来注册 handler的. 我们看下相关代码:  </p>
<p>( btw:  h3 和上文提到的 citty 还有合并option 的 defu 都是 nuxt 团队自己写的, 用了 unjs 的马甲)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createDevServer</span>(<span class="params"><span class="attr">nitro</span>: <span class="title class_">Nitro</span></span>): <span class="title class_">NitroDevServer</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="title function_">createApp</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> handler <span class="keyword">of</span> nitro.<span class="property">options</span>.<span class="property">devHandlers</span>) &#123;</span><br><span class="line">    app.<span class="title function_">use</span>(handler.<span class="property">route</span> || <span class="string">&quot;/&quot;</span>, handler.<span class="property">handler</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  app.<span class="title function_">use</span>(</span><br><span class="line">    <span class="title function_">eventHandler</span>(<span class="title function_">async</span> (event) =&gt; &#123;</span><br><span class="line">      <span class="keyword">await</span> reloadPromise;</span><br><span class="line">      <span class="keyword">const</span> address = <span class="title function_">getWorkerAddress</span>();</span><br><span class="line">      <span class="keyword">if</span> (!address) &#123;</span><br><span class="line">        <span class="keyword">const</span> error = lastError || <span class="title function_">createError</span>(<span class="string">&quot;Worker not ready&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">errorHandler</span>(error, event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">await</span> proxy.<span class="title function_">handle</span>(event, &#123; <span class="attr">target</span>: address <span class="keyword">as</span> <span class="built_in">any</span> &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        lastError = error;</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码是截取的, 第一个<code>use()</code>是读取了<code>nitro.options.devHandlers</code>, 刚才说过是通过<code>server:devHandler</code>注册 handler的, 是来配合 vite 使用的, 在下个章节展开.</p>
<p>第二个<code>use()</code>是配合 server render 的. 可以看到这里把请求代理到一个 worker 了.</p>
<p>我们看一下这个 worker 的来历. (代码也在 createDevServer 中, 在上面的代码块中被我删减了)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getWorkerAddress</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> address = currentWorker?.<span class="property">address</span>;</span><br><span class="line">  <span class="keyword">return</span> address;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">currentWorker</span>: <span class="title class_">NitroWorker</span> | <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> workerEntry = <span class="title function_">resolve</span>(</span><br><span class="line">  nitro.<span class="property">options</span>.<span class="property">output</span>.<span class="property">dir</span>,</span><br><span class="line">  nitro.<span class="property">options</span>.<span class="property">output</span>.<span class="property">serverDir</span>,</span><br><span class="line">  <span class="string">&quot;index.mjs&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">reload</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// Kill old worker</span></span><br><span class="line">  <span class="keyword">const</span> oldWorker = currentWorker;</span><br><span class="line">  currentWorker = <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">killWorker</span>(oldWorker, nitro);</span><br><span class="line">  <span class="comment">// Create a new worker</span></span><br><span class="line">  currentWorker = <span class="keyword">await</span> <span class="title function_">initWorker</span>(workerEntry);</span><br><span class="line">  </span><br><span class="line">  nitro.<span class="property">hooks</span>.<span class="title function_">hook</span>(<span class="string">&quot;dev:reload&quot;</span>, reload);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看2个信息:</p>
<ul>
<li>这个 worker 是 <code>dev:reload</code> 事件触发的. 搜了一下看起来是 rollup 构建结束触发的.</li>
<li>worker 的文件地址看起来是”打包结果的server部分”.</li>
</ul>
<h4 id="build-client"><a href="#build-client" class="headerlink" title="build client"></a>build client</h4><p>下面让我们进入应用的构建部分. </p>
<p>这需要我们的思路跳到父级分支, 2部分构建都是在<code>kit.buildNuxt(this._currentNuxt)</code>中调用的.</p>
<p><code>buildNuxt()</code>也是通过配置加载的, 调用的是<code>nuxt/src/core/builder.ts</code>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"><span class="attr">nuxt</span>: <span class="title class_">Nuxt</span></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!nuxt.<span class="property">options</span>.<span class="property">_prepare</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([<span class="title function_">checkForExternalConfigurationFiles</span>(), <span class="title function_">bundle</span>(nuxt)])</span><br><span class="line">    <span class="keyword">await</span> nuxt.<span class="title function_">callHook</span>(<span class="string">&#x27;build:done&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 build 方法中可以看到, 调用了<code>bundle()</code>方法.</p>
<p>这个 <code>bundle()</code>方法也是通过配置加载的, 按默认的配置, 现在是加载了 nuxt-vite-bundler, 文件在 nuxt 仓库的 <code>packages/vite/vite.ts</code>.</p>
<p>在整理了一系列参数后, 调用了:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="title function_">buildClient</span>(ctx)</span><br><span class="line"><span class="keyword">await</span> <span class="title function_">buildServer</span>(ctx)</span><br></pre></td></tr></table></figure>

<p>是的, 之前整理的就是 ctx. 那正式开始看<code>buildClient()</code>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">buildClient</span> (<span class="params"><span class="attr">ctx</span>: <span class="title class_">ViteBuildContext</span></span>) &#123; <span class="comment">// 也是省略了前部分整理配置的代码</span></span><br><span class="line">   <span class="keyword">if</span> (ctx.<span class="property">nuxt</span>.<span class="property">options</span>.<span class="property">dev</span>) &#123;</span><br><span class="line">    <span class="comment">// Dev</span></span><br><span class="line">    <span class="keyword">const</span> viteServer = <span class="keyword">await</span> vite.<span class="title function_">createServer</span>(clientConfig)</span><br><span class="line">    ctx.<span class="property">clientServer</span> = viteServer</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="property">nuxt</span>.<span class="title function_">callHook</span>(<span class="string">&#x27;vite:serverCreated&#x27;</span>, viteServer, &#123; <span class="attr">isClient</span>: <span class="literal">true</span>, <span class="attr">isServer</span>: <span class="literal">false</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> viteMiddleware = <span class="title function_">defineEventHandler</span>(<span class="title function_">async</span> (event) =&gt; &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        viteServer.<span class="property">middlewares</span>.<span class="title function_">handle</span>(event.<span class="property">node</span>.<span class="property">req</span>, event.<span class="property">node</span>.<span class="property">res</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="property">nuxt</span>.<span class="title function_">callHook</span>(<span class="string">&#x27;server:devHandler&#x27;</span>, viteMiddleware)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和上文说的一样, 通过调用<code>server:devHandler</code>, 把<code>viteMiddleware</code>注册到<code>nitro.options.devHandlers</code>中.</p>
<p><code>viteMiddleware</code>做的事就是把请求交给起起来后的 vite 处理.</p>
<h4 id="build-server"><a href="#build-server" class="headerlink" title="build server"></a>build server</h4><p>看完 nitro 是如何把请求交给 client, 接下来思路回到父级, 看看 nitro 是如何把 server render 的请求交给 worker, 这个 worker 又是如何启动的.</p>
<p>在调用了 nuxt 的 build 方法调用了 vite 的 <code>bundle()</code>后, 触发了<code>await nuxt.callHook(&#39;build:done&#39;)</code>.</p>
<p>可以看到这个事件是在<code>initNitro()</code>中被注册的, 然后调用了 nitro 的 <code>build()</code>方法:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// nuxt build/dev</span></span><br><span class="line">nuxt.<span class="title function_">hook</span>(<span class="string">&#x27;build:done&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> nuxt.<span class="title function_">callHook</span>(<span class="string">&#x27;nitro:build:before&#x27;</span>, nitro)</span><br><span class="line">  <span class="keyword">if</span> (nuxt.<span class="property">options</span>.<span class="property">dev</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">build</span>(nitro)</span><br><span class="line">  &#125; </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">build</span>(<span class="params"><span class="attr">nitro</span>: <span class="title class_">Nitro</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> rollupConfig = <span class="title function_">getRollupConfig</span>(nitro);</span><br><span class="line">  <span class="keyword">await</span> nitro.<span class="property">hooks</span>.<span class="title function_">callHook</span>(<span class="string">&quot;rollup:before&quot;</span>, nitro, rollupConfig);</span><br><span class="line">  <span class="keyword">return</span> nitro.<span class="property">options</span>.<span class="property">dev</span></span><br><span class="line">    ? <span class="title function_">watchDev</span>(nitro, rollupConfig)</span><br><span class="line">    : <span class="title function_">buildProduction</span>(nitro, rollupConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这里, worker是如何启动的2个问题就都解决了:</p>
<p>在<code>getRollupConfig()</code>中, 我们看到了输入路径是之前提到的 worker 文件所在的地方:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">dir</span>: nitro.<span class="property">options</span>.<span class="property">output</span>.<span class="property">serverDir</span>,</span><br><span class="line">    <span class="attr">entryFileNames</span>: <span class="string">&quot;index.mjs&quot;</span>,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>并且我们的流程, 会走到 <code>build()</code>方法的<code>watchDev()</code>中.</p>
<p>可以看到<code>watchDev()</code>方法触发了<code>startRollupWatcher()</code>.</p>
<p>接下来<code>startRollupWatcher()</code>给 rollup 编译完成事件注册了触发了<code>dev:reload</code>事件, 以触发上文提到的<code>reload()</code>方法, 以启动 worker. (worker入口是刚才 rollup 编译的输出)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">startRollupWatcher</span>(<span class="params"><span class="attr">nitro</span>: <span class="title class_">Nitro</span>, <span class="attr">rollupConfig</span>: <span class="title class_">RollupConfig</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> watcher = rollup.<span class="title function_">watch</span>(</span><br><span class="line">    <span class="title function_">defu</span>(rollupConfig, &#123;</span><br><span class="line">      <span class="attr">watch</span>: &#123;</span><br><span class="line">        <span class="attr">chokidar</span>: nitro.<span class="property">options</span>.<span class="property">watchOptions</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  watcher.<span class="title function_">on</span>(<span class="string">&quot;event&quot;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (event.<span class="property">code</span>) &#123;</span><br><span class="line">      <span class="comment">// Finished building all bundles</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&quot;END&quot;</span>: &#123;</span><br><span class="line">        nitro.<span class="property">hooks</span>.<span class="title function_">callHook</span>(<span class="string">&quot;compiled&quot;</span>, nitro);</span><br><span class="line">        nitro.<span class="property">hooks</span>.<span class="title function_">callHook</span>(<span class="string">&quot;dev:reload&quot;</span>); <span class="comment">// 触发 上文提到的 reload() 方法</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> watcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="client-入口-与-server-render入口"><a href="#client-入口-与-server-render入口" class="headerlink" title="client 入口 与 server render入口"></a>client 入口 与 server render入口</h2><p>总结一下上面的内容: <strong>nuxt 把请求都交给 nitro 处理, 浏览器端的请求会代理到 vite 服务, server render 的请求会代理到 一个 worker</strong>.</p>
<p>虽然我们走通了”从请求到处理请求的终端”, 但 debug 的过程还是不系统, 可以通过再整理源码或看文档的 hooks 介绍来完整.</p>
<p>另外还有个没深入的点是 路由与 vite 配置, 很多 nuxt 功能都是在 vite 插件里实现的.</p>
<p>虽然暂时打算不看了, 但还是要把 client 入口 和 server render 入口记录下, 便于以后有问题继续查看.</p>
<ul>
<li>server render 的入口: 根据<code>getRollupConfig(nitro)</code>的返回结果, 与对 nitropack 的观察, 结果是: <code>nitropack/src/presets/\_nitro/runtime/nitro-dev.ts</code></li>
<li>client 的入口: 可以从 nuxt 配置里看到是在<code>nuxt/src/app/components/nuxt-root.vue</code>.</li>
</ul>
</div><div class="post-footer"></div><p> (本文完)</p><p> 如果你可以 <a href="/about/give-me-a-coffee.html">点击这个链接打赏我5毛</a>来鼓励我, 非常感谢.</p><p> 本文遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">cc协议</a></p><p> 你可以在注明出处和非商用的前提下任意复制及演绎</p><div class="post-footer"></div><div class="tags"><a href="/tags/ssr/">ssr</a><a href="/tags/nuxt/">nuxt</a></div><div class="post-nav"><a class="pre" href="/2024/08/07/record-of-24-7-25/">7月25日记录</a><a class="next" href="/2024/06/18/ssr-brief-mechanism-and-code-constrains-through-vue/">通过vue ssr简单实现来理解代码限制</a></div><div id="SOHUCS"></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><p>©&nbsp;<a href="/." rel="nofollow">EL PSY CONGROO. </a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/">沪ICP备16053193号-2</a></p><p>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> | Designed by hahahaha</p></div></div></div></div><script>document.body.className = localStorage.getItem('yo-cwj-theme') || 't1'
</script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="https://cy-cdn.kuaizhan.com/js/??lib/jquery.js,changyan.labs.https.js?appid=cyt1bgEED" async></script><script>(function () {
    var appid = 'cyt1bgEED';
    var conf = 'prod_20e8d05c4d6b3ce62b89be98ae18390c';
    var width = window.innerWidth || document.documentElement.clientWidth;
    if (width < 960) {
        var head = document.getElementsByTagName('head')[0]||document.head||document.documentElement;
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.charset = 'utf-8';
        script.id = 'changyan_mobile_js';
        script.src = 'https://cy-cdn.kuaizhan.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
        head.appendChild(script);
    } else {
        var loadJs=function(d,a){
        var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;
        var b=document.createElement("script");
        b.setAttribute("type","text/javascript");
        b.setAttribute("charset","UTF-8");b.setAttribute("src",d);
        if(typeof a==="function"){
          if(window.attachEvent){
            b.onreadystatechange=function(){
              var e=b.readyState;
              if(e==="loaded"||e==="complete"){
                b.onreadystatechange=null;
                a();
              }
            }
            }else{
              b.onload=a
            }
          }
          c.appendChild(b)
        };
      loadJs("https://cy-cdn.kuaizhan.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})});
    }
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></html>