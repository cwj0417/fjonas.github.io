<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="chen wen jun's blog"><meta name="baidu-site-verification" content="no5dkv1A7T"><title>从provide和inject聊一下vue3的use | EL PSY CONGROO</title><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><script type="text/javascript" src="/js/main.js"></script><script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script><link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css"><script type="text/javascript" src="/js/post.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body></body><div id="header"><div class="body_container"><div id="nav-menu"><a class="current" href="/."> 主页</a><a href="/archives/"> 归档</a><a target="_blank" rel="noopener" href="https://next.yo-cwj.com"> 项目</a><a href="/about/"> 关于</a></div><div class="site-name"><img class="avatar" src="/./img/avatar.png"><div class="theme-selector"><div class="selector" onclick="document.body.className = 't1';localStorage.setItem('yo-cwj-theme', 't1')" style="background: #00c7ff;"></div><div class="selector" onclick="document.body.className = 't2';localStorage.setItem('yo-cwj-theme', 't2')" style="background: #ffe100;"></div><div class="selector" onclick="document.body.className = 't3';localStorage.setItem('yo-cwj-theme', 't3')" style="background: #55ff00;"></div></div><br><h1 class="hidden">从provide和inject聊一下vue3的use</h1><a id="logo" href="/.">EL PSY CONGROO</a><p class="description">陈文俊的博客</p><p class="links"><a target="_blank" rel="noopener" href="https://segmentfault.com/u/xpang"><img src="/./img/sf.ico"></a><a target="_blank" rel="noopener" href="https://github.com/cwj0417"><img src="/./img/github.png"></a><a target="_blank" rel="noopener" href="https://dribbble.com/fjonas"><img src="/./img/dribbble.ico"></a><a target="_blank" rel="noopener" href="https://weibo.com/2719310113"><img src="/./img/weibo.ico"></a></p></div></div></div><div class="body_container"><div class="pure-g" id="layout"><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="搜索内容或标题" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-paperclip"> </i>标签</div><div class="tagcloud"><a href="/tags/%E5%85%A5%E9%97%A8/" style="font-size: 20px;">入门</a> <a href="/tags/webpack/" style="font-size: 20px;">webpack</a> <a href="/tags/vue/" style="font-size: 19.57px;">vue</a> <a href="/tags/javascript/" style="font-size: 19.14px;">javascript</a> <a href="/tags/%E7%BF%BB%E8%AF%91/" style="font-size: 18.71px;">翻译</a> <a href="/tags/%E6%B7%B1%E5%85%A5es6/" style="font-size: 18.29px;">深入es6</a> <a href="/tags/vue%E6%BA%90%E7%A0%81/" style="font-size: 17.86px;">vue源码</a> <a href="/tags/%E5%BA%94%E7%94%A8/" style="font-size: 17.43px;">应用</a> <a href="/tags/%E5%88%86%E6%9E%90/" style="font-size: 17.43px;">分析</a> <a href="/tags/%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 17px;">心理学</a> <a href="/tags/electron/" style="font-size: 17px;">electron</a> <a href="/tags/react/" style="font-size: 16.57px;">react</a> <a href="/tags/haha/" style="font-size: 16.14px;">haha</a> <a href="/tags/%E4%BA%BA%E6%A0%BC%E5%BF%83%E7%90%86%E5%AD%A6/" style="font-size: 15.71px;">人格心理学</a> <a href="/tags/%E5%8D%9A%E5%AE%A2%E8%A3%85%E9%A5%B0/" style="font-size: 15.71px;">博客装饰</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%84%E7%BB%87/" style="font-size: 15.29px;">代码组织</a> <a href="/tags/%E8%A7%A3%E9%87%8A%E8%84%91/" style="font-size: 15.29px;">解释脑</a> <a href="/tags/%E8%B5%84%E6%9C%AC%E8%AE%BA/" style="font-size: 15.29px;">资本论</a> <a href="/tags/angular/" style="font-size: 14.86px;">angular</a> <a href="/tags/d3/" style="font-size: 14.86px;">d3</a> <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" style="font-size: 14.86px;">小程序</a> <a href="/tags/hama/" style="font-size: 14.86px;">hama</a> <a href="/tags/ssr/" style="font-size: 14.86px;">ssr</a> <a href="/tags/nuxt/" style="font-size: 14.86px;">nuxt</a> <a href="/tags/ae-exp/" style="font-size: 14.43px;">ae exp</a> <a href="/tags/immer/" style="font-size: 14.43px;">immer</a> <a href="/tags/chrome-extension/" style="font-size: 14.43px;">chrome extension</a> <a href="/tags/codemirror/" style="font-size: 14.43px;">codemirror</a> <a href="/tags/vite/" style="font-size: 14.43px;">vite</a> <a href="/tags/ci/" style="font-size: 14.43px;">ci</a> <a href="/tags/github-action/" style="font-size: 14.43px;">github action</a> <a href="/tags/monorepo/" style="font-size: 14.43px;">monorepo</a> <a href="/tags/http/" style="font-size: 14.43px;">http</a> <a href="/tags/git/" style="font-size: 14.43px;">git</a> <a href="/tags/%E4%BA%94%E8%A1%8C%E5%85%AB%E5%8D%A6/" style="font-size: 14.43px;">五行八卦</a> <a href="/tags/vuex/" style="font-size: 14.43px;">vuex</a> <a href="/tags/redux/" style="font-size: 14.43px;">redux</a> <a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/" style="font-size: 14px;">年终总结</a> <a href="/tags/%E6%91%A9%E6%89%98%E8%BD%A6/" style="font-size: 14px;">摩托车</a> <a href="/tags/chrome-extension/" style="font-size: 14px;">chrome-extension</a> <a href="/tags/vscode/" style="font-size: 14px;">vscode</a> <a href="/tags/%E9%A2%9C%E8%89%B2/" style="font-size: 14px;">颜色</a> <a href="/tags/eslint/" style="font-size: 14px;">eslint</a> <a href="/tags/svg/" style="font-size: 14px;">svg</a> <a href="/tags/shortcuts/" style="font-size: 14px;">shortcuts</a> <a href="/tags/web/" style="font-size: 14px;">web</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 14px;">抓包</a> <a href="/tags/hook/" style="font-size: 14px;">hook</a> <a href="/tags/typescript/" style="font-size: 14px;">typescript</a> <a href="/tags/%E9%81%93%E5%BE%B7%E6%83%85%E6%93%8D%E8%AE%BA/" style="font-size: 14px;">道德情操论</a> <a href="/tags/jenkins/" style="font-size: 14px;">jenkins</a> <a href="/tags/%E6%AD%A3%E5%88%99/" style="font-size: 14px;">正则</a> <a href="/tags/%E6%95%B0%E5%AD%A6%E7%9A%84%E9%9B%A8%E4%BC%9E%E4%B8%8B/" style="font-size: 14px;">数学的雨伞下</a> <a href="/tags/esbuild/" style="font-size: 14px;">esbuild</a> <a href="/tags/%E7%9B%B8%E5%AF%B9%E8%AE%BA/" style="font-size: 14px;">相对论</a> <a href="/tags/cordova/" style="font-size: 14px;">cordova</a> <a href="/tags/vite-plugin/" style="font-size: 14px;">vite-plugin</a> <a href="/tags/%E9%98%BF%E5%BE%B7%E5%8B%92/" style="font-size: 14px;">阿德勒</a> <a href="/tags/weex/" style="font-size: 14px;">weex</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-commenting-o"> </i>最近评论</div><div class="epcRecentComments" id="cyReping" role="cylabs" data-use="reping"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> </i>友情链接</div><div class="links"><a href="https://blog.csdn.net/u010416101" title="sean(大数据专家, 人工智能专家)" target="_blank">sean(大数据专家, 人工智能专家)</a><a href="https://blog.csdn.net/u012373815" title="abel(大数据专家, 人工智能专家)" target="_blank">abel(大数据专家, 人工智能专家)</a><a href="https://di1shuai.com/" title="bruce(大数据专家, 人工智能专家)" target="_blank">bruce(大数据专家, 人工智能专家)</a><a href="https://www.cnblogs.com/linxiyue/" title="邓雪(全栈开发专家)" target="_blank">邓雪(全栈开发专家)</a><a href="https://www.xilanhua-c7.top/" title="赵吉(后现代浪漫主义诗人)" target="_blank">赵吉(后现代浪漫主义诗人)</a><a href="https://blog.csdn.net/weixin_40413961" title="98年新栋(首席实习生)" target="_blank">98年新栋(首席实习生)</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">从provide和inject聊一下vue3的use</h1><div class="post-meta">Dec 14, 2024<span> | </span><span class="category"><a href="/categories/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/">工作笔记</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 次阅读</span></span></div><div class="post-content"><p>接上次看<code>vue-router</code>看到了<code>provide</code>和<code>inject</code>, 觉得应该比较简单, 打算看一下实现.</p>
<p>过程中发现<code>provide</code>, <code>inject</code>与其他一些 api 比如<code>onMounted</code>, <code>onUnmounted</code>是不能在异步结果中调用的. (更不能在setup外调用)</p>
<p>另外<code>provide</code>的时候可不可以<code>inject</code>到自己也不太确定. (虽然文档里都说得很明确)</p>
<span id="more"></span>

<h2 id="provide-inject用法"><a href="#provide-inject用法" class="headerlink" title="provide&#x2F;inject用法"></a>provide&#x2F;inject用法</h2><p>普通的用法就是<code>provide(key, value)</code>, 这样是子孙组件中就可以通过<code>inject(key)</code>获取到<code>value</code>了.</p>
<p>需要注意的是这需要在<code>setup()</code>中同步调用. 其实<code>inject()</code>也是一样的, 只是取值不会有异步场景所以文档中没提示.</p>
<p><code>setup()</code>是组件里的, 而在插件中不是一定加载组件的, 所以还有所谓”app level provide”, 方式就是<code>app.provide(key, value)</code>.</p>
<p>先从比较简单的app-level provide开始.</p>
<h2 id="app-level-provide"><a href="#app-level-provide" class="headerlink" title="app-level provide"></a>app-level provide</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createApp</span>(<span class="params">rootComponent, rootProps = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="comment">// ...option api兼容和其他app方法用到的变量声明</span></span><br><span class="line">    <span class="keyword">const</span> context = &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="attr">app</span>: <span class="literal">null</span> <span class="keyword">as</span> <span class="built_in">any</span>,</span><br><span class="line">      <span class="attr">provides</span>: <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">app</span>: <span class="title class_">App</span> = (context.<span class="property">app</span> = &#123;</span><br><span class="line">      <span class="attr">_context</span>: context,</span><br><span class="line">      <span class="comment">// ...use, directive, component等方法</span></span><br><span class="line">      <span class="title function_">mount</span>(</span><br><span class="line">        <span class="attr">rootContainer</span>: <span class="title class_">HostElement</span>,</span><br><span class="line">        <span class="attr">isHydrate</span>?: <span class="built_in">boolean</span>,</span><br><span class="line">        <span class="attr">namespace</span>?: <span class="built_in">boolean</span> | <span class="title class_">ElementNamespace</span>,</span><br><span class="line">      ): <span class="built_in">any</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isMounted) &#123;</span><br><span class="line">          <span class="keyword">const</span> vnode = app.<span class="property">_ceVNode</span> || <span class="title function_">createVNode</span>(rootComponent, rootProps)</span><br><span class="line">          <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">          <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">          vnode.<span class="property">appContext</span> = context</span><br><span class="line">          <span class="comment">// ...mount流程</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">provide</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">        context.<span class="property">provides</span>[key <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">symbol</span>] = value</span><br><span class="line">        <span class="keyword">return</span> app</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">runWithContext</span>(<span class="params">fn</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> lastApp = currentApp</span><br><span class="line">        currentApp = app</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">fn</span>()</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          currentApp = lastApp</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>这个是我们启动vue流程要调用的<code>createApp()</code>, 他返回的<code>app</code>对象中的<code>provide()</code>方法非常简单, 就是把键值写到<code>context.provides</code>里.</p>
<p>而这个<code>context</code>可以从<code>app._context</code>, 或者是根节点的<code>vnode</code>的<code>appContext</code>里获取到.</p>
<p>这个<code>vnode</code>又会被<code>mount()</code>后续的动作传到后面的子组件实例里. </p>
<h2 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h2><p><code>provide</code>设置的内容放在了<code>app._context</code>中, 我们看一下<code>inject</code>是如何取到的.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">key</span>: <span class="title class_">InjectionKey</span>&lt;<span class="built_in">any</span>&gt; | <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">defaultValue</span>?: <span class="built_in">unknown</span>,</span></span><br><span class="line"><span class="params">  treatDefaultAsFactory = <span class="literal">false</span>,</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// fallback to `currentRenderingInstance` so that this can be called in</span></span><br><span class="line">  <span class="comment">// a functional component</span></span><br><span class="line">  <span class="keyword">const</span> instance = currentInstance || currentRenderingInstance</span><br><span class="line"></span><br><span class="line">  <span class="comment">// also support looking up from app-level provides w/ `app.runWithContext()`</span></span><br><span class="line">  <span class="keyword">if</span> (instance || currentApp) &#123;</span><br><span class="line">    <span class="comment">// #2400</span></span><br><span class="line">    <span class="comment">// to support `app.use` plugins,</span></span><br><span class="line">    <span class="comment">// fallback to appContext&#x27;s `provides` if the instance is at root</span></span><br><span class="line">    <span class="comment">// #11488, in a nested createApp, prioritize using the provides from currentApp</span></span><br><span class="line">    <span class="keyword">const</span> provides = currentApp</span><br><span class="line">      ? currentApp.<span class="property">_context</span>.<span class="property">provides</span></span><br><span class="line">      : instance</span><br><span class="line">        ? instance.<span class="property">parent</span> == <span class="literal">null</span></span><br><span class="line">          ? instance.<span class="property">vnode</span>.<span class="property">appContext</span> &amp;&amp; instance.<span class="property">vnode</span>.<span class="property">appContext</span>.<span class="property">provides</span></span><br><span class="line">          : instance.<span class="property">parent</span>.<span class="property">provides</span></span><br><span class="line">        : <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (provides &amp;&amp; (key <span class="keyword">as</span> <span class="built_in">string</span> | <span class="built_in">symbol</span>) <span class="keyword">in</span> provides) &#123;</span><br><span class="line">      <span class="comment">// TS doesn&#x27;t allow symbol as index type</span></span><br><span class="line">      <span class="keyword">return</span> provides[key <span class="keyword">as</span> <span class="built_in">string</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// ...默认值相关</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到关键点就在于<code>const provides = ...</code>的取值, 之后就是把<code>provides</code>对应的key返回就行.</p>
<p>我们仔细来看<code>provides</code>的取值优先级:</p>
<ol>
<li><p>如果有<code>currentApp</code>就取<code>currentApp._context.provides</code>. 而<code>currentApp</code>这个变量非常明确, 只有<code>runWithContext()</code>可以调用他.</p>
<p>所以这第一个情况是<code>runWithContext()</code>+<code>inject()</code>专属情况.</p>
<p>接下来的情况是有<code>currentInstance</code>的, 也就是在<code>setup()</code>里调用的. (<code>currentRenderingInstance</code>是执行<code>render()</code>函数的时候设置的, 其实是同一个实例.)</p>
</li>
<li><p>如果是根节点, 就取<code>instance.vnode.appContext.provides</code>. 也就是<code>app-level provide</code>设置的值.</p>
</li>
<li><p>如果不是根节点, 就取<code>instance.parent.provides</code>.</p>
</li>
</ol>
<p>看到这里就需要去了解<code>currentInstance</code>了, 因为:</p>
<ul>
<li>上面提到的(2)中, 其实我们只知道<code>vnode.appContext</code>是上面<code>app-level provide</code>的值, 但并不知道<code>instance</code>的<code>vnode</code>是如何挂上的, 挂的是不是期望的<code>vnode</code>, 没有连起来.</li>
<li>上面提到的(3)中, <code>instance</code>的<code>parent</code>是如何挂上的, <code>parent</code>的<code>provides</code>又是什么. (不能因为<code>provides</code>名字而和上文提到的<code>context.provides</code>搞混, 名字类似并不表示他们是指到一个地址的)</li>
<li>最重要的是<code>currentInstance</code>是什么时候被创建的, 对应的是什么实例, parent之间的数据结构又是什么.</li>
</ul>
<h2 id="currentInstance的来源和相关的vue的启动流程"><a href="#currentInstance的来源和相关的vue的启动流程" class="headerlink" title="currentInstance的来源和相关的vue的启动流程"></a>currentInstance的来源和相关的vue的启动流程</h2><p>总结下我们现在的信息: <code>app.provide</code>是把信息存在了一个变量<code>context</code>里, <code>inject</code>取变量的时候分为三个情况, 是通过三个不同的路径取到<code>context</code>的.</p>
<p>其中通过<code>runWithContext()</code>从<code>currentApp</code>取<code>_context</code>, 比较明确, 而后面2个涉及到<code>currentInstance</code>这个变量, 就需要简单理一下从项目入口到调用<code>inject()</code>的过程了.</p>
<h3 id="从入口到patch"><a href="#从入口到patch" class="headerlink" title="从入口到patch()"></a>从入口到<code>patch()</code></h3><p>一个普通vue项目的入口大概是这样的: <code>createApp(App).mount(&#39;#app&#39;)</code>.</p>
<p>其中<code>App</code>从sfc编译过来是个组件声明的js对象, 有<code>setup</code>和<code>render</code>属性, 其实就对应了sfc的<code>script</code>和<code>template</code>.</p>
<p><code>.mount()</code>方法是<code>createApp()</code>返回的, 本文开头有, 现在补充<code>.mount()</code>的详细内容:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="title function_">mount</span>(</span><br><span class="line">      <span class="attr">rootContainer</span>: <span class="title class_">HostElement</span>,</span><br><span class="line">      <span class="attr">isHydrate</span>?: <span class="built_in">boolean</span>,</span><br><span class="line">      <span class="attr">namespace</span>?: <span class="built_in">boolean</span> | <span class="title class_">ElementNamespace</span>,</span><br><span class="line">    ): <span class="built_in">any</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isMounted) &#123;</span><br><span class="line">        <span class="keyword">const</span> vnode = app.<span class="property">_ceVNode</span> || <span class="title function_">createVNode</span>(rootComponent, rootProps)</span><br><span class="line">        <span class="comment">// store app context on the root VNode.</span></span><br><span class="line">        <span class="comment">// this will be set on the root instance on initial mount.</span></span><br><span class="line">        vnode.<span class="property">appContext</span> = context</span><br><span class="line">      	<span class="comment">// ...hmr相关</span></span><br><span class="line">        <span class="keyword">if</span> (isHydrate &amp;&amp; hydrate) &#123;</span><br><span class="line">          <span class="title function_">hydrate</span>(vnode <span class="keyword">as</span> <span class="title class_">VNode</span>&lt;<span class="title class_">Node</span>, <span class="title class_">Element</span>&gt;, rootContainer <span class="keyword">as</span> <span class="built_in">any</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">render</span>(vnode, rootContainer, namespace)</span><br><span class="line">        &#125;</span><br><span class="line">        isMounted = <span class="literal">true</span></span><br><span class="line">        app.<span class="property">_container</span> = rootContainer</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getComponentPublicInstance</span>(vnode.<span class="property">component</span>!)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们是客户端的情况, 所以会走到<code>render()</code>, 创建<code>vnode</code>的参数<code>rootComponent</code>就是<code>createApp(App)</code>的<code>App</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">render</span> = (<span class="params">vnode, container, namespace</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (container.<span class="property">_vnode</span>) &#123;</span><br><span class="line">      <span class="title function_">unmount</span>(container.<span class="property">_vnode</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">patch</span>(</span><br><span class="line">      container.<span class="property">_vnode</span> || <span class="literal">null</span>,</span><br><span class="line">      vnode,</span><br><span class="line">      container,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      namespace</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!isFlushing) &#123;</span><br><span class="line">    isFlushing = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">flushPreFlushCbs</span>();</span><br><span class="line">    <span class="title function_">flushPostFlushCbs</span>();</span><br><span class="line">    isFlushing = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  container.<span class="property">_vnode</span> = vnode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>挂载和卸载都是调用<code>render()</code>, 如果是挂载的情况, 就会调用<code>patch()</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">patch</span> = (<span class="params">...</span>) =&gt; &#123;</span><br><span class="line">   <span class="keyword">if</span> (n1 === n2) &#123;</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (n1 &amp;&amp; !<span class="title function_">isSameVNodeType</span>(n1, n2)) &#123;</span><br><span class="line">     anchor = <span class="title function_">getNextHostNode</span>(n1);</span><br><span class="line">     <span class="title function_">unmount</span>(n1, parentComponent, parentSuspense, <span class="literal">true</span>);</span><br><span class="line">     n1 = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (n2.<span class="property">patchFlag</span> === -<span class="number">2</span>) &#123;</span><br><span class="line">     optimized = <span class="literal">false</span>;</span><br><span class="line">     n2.<span class="property">dynamicChildren</span> = <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">const</span> &#123; type, ref, shapeFlag &#125; = n2;</span><br><span class="line">   <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">     <span class="keyword">case</span> <span class="title class_">Text</span>:</span><br><span class="line">       <span class="title function_">processText</span>(...);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="title class_">Comment</span>:</span><br><span class="line">       <span class="title function_">processCommentNode</span>(...);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="title class_">Static</span>:</span><br><span class="line">       <span class="keyword">if</span> (n1 == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="title function_">mountStaticNode</span>(...);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!!(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>)) &#123;</span><br><span class="line">         <span class="title function_">patchStaticNode</span>(...);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> <span class="title class_">Fragment</span>:</span><br><span class="line">       <span class="title function_">processFragment</span>(...);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="attr">default</span>:</span><br><span class="line">       <span class="keyword">if</span> (shapeFlag &amp; <span class="number">1</span>) &#123;</span><br><span class="line">         <span class="title function_">processElement</span>(...);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="number">6</span>) &#123;</span><br><span class="line">         <span class="title function_">processComponent</span>(...);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="number">64</span>) &#123;</span><br><span class="line">         type.<span class="title function_">process</span>(...);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shapeFlag &amp; <span class="number">128</span>) &#123;</span><br><span class="line">         type.<span class="title function_">process</span>(...);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (ref != <span class="literal">null</span> &amp;&amp; parentComponent) &#123;</span><br><span class="line">     <span class="title function_">setRef</span>(ref, n1 &amp;&amp; n1.<span class="property">ref</span>, parentSuspense, n2 || n1, !n2);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<p><code>patch()</code>的任务是对比”上个状态”和”目标状态”的<code>vnode</code>(<code>n1</code>和<code>n2</code>)调用dom操作.</p>
<p>叶子节点<code>vnode</code>的<code>patch()</code>分2步:</p>
<ol>
<li>根据<code>vnode</code>的类型, 分配给不同函数处理.</li>
<li>根据<code>n1</code>是否存在, 来判断是挂载还是<code>diff</code>. 最后进行dom操作.</li>
</ol>
<p>而我们关心的组件, 不是叶子节点, 会交给<code>processComponent()</code>处理.</p>
<p>组件里最终还是会包含叶子节点的, 在经过一些处理后, 会递归调用<code>patch()</code>, 直到叶子节点, 以dom操作退出递归.</p>
<h3 id="挂载组件"><a href="#挂载组件" class="headerlink" title="挂载组件"></a>挂载组件</h3><p>在<code>n1</code>为空的情况下, <code>processComponent()</code>会把挂载流程交给<code>mountComponent()</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mountComponent</span> = (<span class="params">initialVNode, container, anchor, parentComponent, parentSuspense, namespace, optimized</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = (initialVNode.<span class="property">component</span> = <span class="title function_">createComponentInstance</span>(</span><br><span class="line">    initialVNode,</span><br><span class="line">    parentComponent,</span><br><span class="line">    parentSuspense</span><br><span class="line">  ));</span><br><span class="line">  <span class="comment">// ...keep-alive组件处理</span></span><br><span class="line">  <span class="title function_">setupComponent</span>(instance);</span><br><span class="line">  <span class="keyword">if</span> (instance.<span class="property">asyncDep</span>) &#123;</span><br><span class="line">    <span class="comment">// ...异步组件处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">setupRenderEffect</span>(</span><br><span class="line">      instance,</span><br><span class="line">      initialVNode,</span><br><span class="line">      container,</span><br><span class="line">      anchor,</span><br><span class="line">      parentSuspense,</span><br><span class="line">      namespace,</span><br><span class="line">      optimized</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以看到关键的代码分为这三步:</p>
<ol>
<li><p>创建组件实例, 并挂到<code>vnode</code>的<code>component</code>属性上.</p>
<p><code>inject()</code>就是从这个组件实例中获取<code>provides</code>.</p>
<p>在一些流程中, 组件实例会被设置为<code>currentInstance</code>.</p>
<p>而要获取实例, 以及相关的变量关系是:</p>
<p>dom &#x3D;&gt; dom._vnode (vnode) &#x3D;&gt; vnode.component (component实例), vnode.type (component定义)</p>
</li>
<li><p>进行组件的<code>setup</code>.</p>
<p><code>setup()</code>作用是为<code>render()</code>做准备的.</p>
<p><code>render()</code>的作用是每次运行会返回最新的<code>vnode</code>, 把最新的<code>vnode</code>与老的一起给<code>patch()</code>, 就可以进行<code>diff</code>最后操作dom.</p>
<p><code>setup()</code>只会执行一次, 而<code>render()</code>在每次更新组件都会执行.</p>
<p><code>setup()</code>的形式有很多种, 最常见的sfc是返回<code>template</code>的执行环境, 在一些组件里会直接返回<code>render()</code>函数, 或者是异步组件会返回<code>promise</code>. (但作用都是为<code>render()</code>的执行做准备)</p>
</li>
<li><p>创建组件的<code>render-effect</code>.</p>
<p><code>effect</code>的内容是执行<code>render()</code>函数, 获取到<code>vnode</code>, 并且<code>patch()</code>. (这个流程本文前面已经提到几次了, 以前的文章里有详细说)</p>
<p>然后把<code>effect</code>挂到组件实例上, 再给组件实例挂个<code>update()</code>方法, 就是执行一下<code>effect.run()</code>.</p>
<p>顺带一提, <code>patch</code>组件如果有老<code>vnode</code>, 就会走到<code>updateComponent</code>, 而不是现在的<code>mountComponent</code>, 这时候就会直接执行组件实例的<code>update()</code>方法, 并且把老<code>vnode</code>上的组件实例赋值给新<code>vnode</code>, 而这个<code>vnode</code>会在<code>effect</code>执行的时候被挂到组件实例的<code>subTree</code>上.</p>
</li>
</ol>
<p>其实讲到这里已经理清了. 如果想更清晰, 下面会贴一些这三个步骤的具体代码.</p>
<h3 id="createComponentInstance细节"><a href="#createComponentInstance细节" class="headerlink" title="createComponentInstance细节"></a>createComponentInstance细节</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createComponentInstance</span>(<span class="params">vnode, parent, suspense</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> type = vnode.<span class="property">type</span>;</span><br><span class="line">  <span class="keyword">const</span> appContext = (parent ? parent.<span class="property">appContext</span> : vnode.<span class="property">appContext</span>) || emptyAppContext;</span><br><span class="line">  <span class="keyword">const</span> instance = &#123;</span><br><span class="line">    <span class="comment">// ...省略了一些属性, 保留了一些本文中提及的属性.</span></span><br><span class="line">    type,</span><br><span class="line">    parent,</span><br><span class="line">    appContext,</span><br><span class="line">    <span class="attr">root</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">subTree</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">effect</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">update</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">render</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">proxy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">provides</span>: parent ? parent.<span class="property">provides</span> : <span class="title class_">Object</span>.<span class="title function_">create</span>(appContext.<span class="property">provides</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...一些属性的初始化设置</span></span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在创建组件实例的时候我们细看2个点.</p>
<ul>
<li><p><code>appContext</code>的取值: 根节点会取<code>createApp()</code>时创建的<code>context</code>, 其余组件实例都会指向父实例.</p>
<p>也就是所有组件实例挂上的是同一个<code>context</code>. </p>
<p>(可以通过在任何组件的<code>setup()</code>中打印<code>getCurrentInstance()</code>的<code>appContext</code>都是可以三等的)</p>
</li>
<li><p><code>provides</code>的取值: 与<code>context</code>类似, 但根组件用<code>Object.create()</code>来创建了新对象.</p>
<p>利用js原型链来使修改组件实例的<code>provides</code>不影响<code>context</code>中的, 却能取到<code>context</code>中的值.</p>
<p>如果不是根节点, 就指向父节点. (但在调用<code>provide()</code>的时候会修改, 后面展开)</p>
</li>
</ul>
<p>创建完的组件实例会被频繁的使用, 获取这个实例的方式请看上文的总结.</p>
<h3 id="setup细节"><a href="#setup细节" class="headerlink" title="setup细节"></a>setup细节</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupComponent</span>(<span class="params">instance, isSSR = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  isSSR &amp;&amp; <span class="title function_">setInSSRSetupState</span>(isSSR);</span><br><span class="line">  <span class="keyword">const</span> &#123; props, children &#125; = instance.<span class="property">vnode</span>;</span><br><span class="line">  <span class="keyword">const</span> isStateful = <span class="title function_">isStatefulComponent</span>(instance);</span><br><span class="line">  <span class="title function_">initProps</span>(instance, props, isStateful, isSSR);</span><br><span class="line">  <span class="title function_">initSlots</span>(instance, children);</span><br><span class="line">  <span class="keyword">const</span> setupResult = isStateful ? <span class="title function_">setupStatefulComponent</span>(instance, isSSR) : <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">  isSSR &amp;&amp; <span class="title function_">setInSSRSetupState</span>(<span class="literal">false</span>);</span><br><span class="line">  <span class="keyword">return</span> setupResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把<code>vnode</code>上的属性同步到组件实例上, 并调用<code>setupStatefulComponent()</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params">instance, isSSR</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> _a;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line">  instance.<span class="property">accessCache</span> = <span class="comment">/* @__PURE__ */</span> <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="keyword">new</span> <span class="title class_">Proxy</span>(instance.<span class="property">ctx</span>, <span class="title class_">PublicInstanceProxyHandlers</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span>;</span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="keyword">const</span> setupContext = instance.<span class="property">setupContext</span> = setup.<span class="property">length</span> &gt; <span class="number">1</span> ? <span class="title function_">createSetupContext</span>(instance) : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> reset = <span class="title function_">setCurrentInstance</span>(instance);</span><br><span class="line">    <span class="title function_">pauseTracking</span>();</span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">callWithErrorHandling</span>(</span><br><span class="line">      setup,</span><br><span class="line">      instance,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      [</span><br><span class="line">        !!(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>) ? <span class="title function_">shallowReadonly</span>(instance.<span class="property">props</span>) : instance.<span class="property">props</span>,</span><br><span class="line">        setupContext</span><br><span class="line">      ]</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">resetTracking</span>();</span><br><span class="line">    <span class="title function_">reset</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isPromise</span>(setupResult)) &#123;</span><br><span class="line">      <span class="comment">// ...异步组件的处理</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">handleSetupResult</span>(instance, setupResult, isSSR);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">finishComponentSetup</span>(instance, isSSR);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在执行<code>setup()</code>前后分别调用了<code>setCurrentInstance(instance)</code>和<code>reset()</code>.</p>
<p>然后获得<code>setup()</code>的执行结果, 会在接下来的<code>handleSetupResult()</code>里来处理不同类型的结果.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleSetupResult</span>(<span class="params">instance, setupResult, isSSR</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isFunction</span>(setupResult)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (instance.<span class="property">type</span>.<span class="property">__ssrInlineRender</span>) &#123;</span><br><span class="line">      instance.<span class="property">ssrRender</span> = setupResult;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      instance.<span class="property">render</span> = setupResult;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isObject</span>(setupResult)) &#123;</span><br><span class="line">    instance.<span class="property">setupState</span> = <span class="title function_">proxyRefs</span>(setupResult);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">finishComponentSetup</span>(instance, isSSR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常用的sfc, <code>setup()</code>返回的是对象, 这个对象会作为<code>template</code>的执行环境, 会走到<code>instance.setupState = proxyRefs(setupResult)</code></p>
<p>组件因为比较灵活, <code>setup()</code>可能返回<code>render()</code>函数, 会走到<code>instance.render = setupResult</code>.</p>
<p>(到这里已经可以猜到, 在创建<code>render-effect</code>的时候, 就会带着”<code>setupState</code>“来跑<code>render()</code>函数来获取最新的<code>vnode</code>)</p>
<p>到现在, sfc情况的组件实例还没有<code>render()</code>函数, 所以在<code>finishComponentSetup()</code>里处理.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">finishComponentSetup</span>(<span class="params">instance, isSSR, skipOptions</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span>;</span><br><span class="line">  <span class="keyword">if</span> (!instance.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isSSR &amp;&amp; compile &amp;&amp; !<span class="title class_">Component</span>.<span class="property">render</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> template = <span class="title class_">Component</span>.<span class="property">template</span> || <span class="title function_">resolveMergedOptions</span>(instance).<span class="property">template</span>;</span><br><span class="line">      <span class="keyword">if</span> (template) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; isCustomElement, compilerOptions &#125; = instance.<span class="property">appContext</span>.<span class="property">config</span>;</span><br><span class="line">        <span class="keyword">const</span> &#123; delimiters, <span class="attr">compilerOptions</span>: componentCompilerOptions &#125; = <span class="title class_">Component</span>;</span><br><span class="line">        <span class="keyword">const</span> finalCompilerOptions = <span class="title function_">extend</span>(</span><br><span class="line">          <span class="title function_">extend</span>(</span><br><span class="line">            &#123;</span><br><span class="line">              isCustomElement,</span><br><span class="line">              delimiters</span><br><span class="line">            &#125;,</span><br><span class="line">            compilerOptions</span><br><span class="line">          ),</span><br><span class="line">          componentCompilerOptions</span><br><span class="line">        );</span><br><span class="line">        <span class="title class_">Component</span>.<span class="property">render</span> = <span class="title function_">compile</span>(template, finalCompilerOptions);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    instance.<span class="property">render</span> = <span class="title class_">Component</span>.<span class="property">render</span> || <span class="variable constant_">NOOP</span>;</span><br><span class="line">    <span class="keyword">if</span> (installWithProxy) &#123;</span><br><span class="line">      <span class="title function_">installWithProxy</span>(instance);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到给组件实例的<code>render()</code>函数赋值为<code>instance.render = Component.render</code>.</p>
<p>这个<code>Component</code>是组件定义对象. 按我理解, 正常的sfc走到这里, <code>template</code>已经在编译时被编译成<code>render()</code>函数了.</p>
<p>如果在组件定义时使用了js对象, 又手动写了<code>template</code>属性, 在这里会进行一次运行时编译. (如果引入的vue没有运行时编译, 会进行提示, 我这里没有贴这段代码)</p>
<p>到这里, <code>setup()</code>的任务已经做完了, 组件实例有了<code>render()</code>方法和执行环境, (执行<code>render()</code>方法后就能获得最新<code>vnode</code>), 就可以下一步建立组件的render-effect了.</p>
<h3 id="render-effect细节"><a href="#render-effect细节" class="headerlink" title="render-effect细节"></a>render-effect细节</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">setupRenderEffect</span> = (<span class="params">instance, initialVNode, container, anchor, parentSuspense, namespace, optimized</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">componentUpdateFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="comment">// ..</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> effect = instance.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(</span><br><span class="line">      componentUpdateFn,</span><br><span class="line">      <span class="variable constant_">NOOP</span>,</span><br><span class="line">      <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(update),</span><br><span class="line">      instance.<span class="property">scope</span></span><br><span class="line">      <span class="comment">// track it in component&#x27;s effect scope</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> update = instance.<span class="property">update</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (effect.<span class="property">dirty</span>) &#123;</span><br><span class="line">        effect.<span class="title function_">run</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    update.<span class="property">id</span> = instance.<span class="property">uid</span>;</span><br><span class="line">    <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>);</span><br><span class="line">    <span class="title function_">update</span>();</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>上文的总结已经提到, 建立render-effect的时候做了这几件事:</p>
<ul>
<li><p>创建一个<code>effect</code>, 内容是执行<code>render()</code>函数, 获取最新<code>vnode</code>, 再把新老<code>vnode</code>进行<code>patch()</code>.</p>
<p>(<code>effect</code>属于响应式知识, 以前的文章有写过, <code>patch()</code>的作用前文也提到几次了)</p>
</li>
<li><p>组件实例挂上这个<code>effect</code>.</p>
</li>
<li><p>组件实例挂上<code>update()</code>方法, 内容是执行<code>effect()</code>. 这是便于<code>updateComponent</code>调用.</p>
</li>
<li><p>立马执行这个<code>effect()</code>. (最后一行<code>update()</code>)</p>
</li>
</ul>
<p>现在来看一下执行<code>render()</code>函数, 获取<code>vnode</code>进行<code>patch()</code>的细节:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">componentUpdateFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!instance.<span class="property">isMounted</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> vnodeHook;</span><br><span class="line">        <span class="keyword">const</span> &#123; el, props &#125; = initialVNode;</span><br><span class="line">        <span class="keyword">const</span> &#123; bm, m, parent &#125; = instance;</span><br><span class="line">        <span class="keyword">const</span> isAsyncWrapperVNode = <span class="title function_">isAsyncWrapper</span>(initialVNode);</span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">          <span class="title function_">invokeArrayFns</span>(bm);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isAsyncWrapperVNode &amp;&amp; (vnodeHook = props &amp;&amp; props.<span class="property">onVnodeBeforeMount</span>)) &#123;</span><br><span class="line">          <span class="title function_">invokeVNodeHook</span>(vnodeHook, parent, initialVNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (el &amp;&amp; hydrateNode) &#123;</span><br><span class="line">          <span class="comment">// ...同构渲染的情况</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> subTree = instance.<span class="property">subTree</span> = <span class="title function_">renderComponentRoot</span>(instance);</span><br><span class="line">          <span class="title function_">patch</span>(</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            subTree,</span><br><span class="line">            container,</span><br><span class="line">            anchor,</span><br><span class="line">            instance,</span><br><span class="line">            parentSuspense,</span><br><span class="line">            namespace</span><br><span class="line">          );</span><br><span class="line">          initialVNode.<span class="property">el</span> = subTree.<span class="property">el</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...后续流程, 以后再讨论</span></span><br><span class="line">        instance.<span class="property">isMounted</span> = <span class="literal">true</span>;</span><br><span class="line">        initialVNode = container = anchor = <span class="literal">null</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; next, bu, u, parent, vnode &#125; = instance;</span><br><span class="line">        <span class="keyword">let</span> originNext = next;</span><br><span class="line">        <span class="keyword">let</span> vnodeHook;</span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (next) &#123;</span><br><span class="line">          next.<span class="property">el</span> = vnode.<span class="property">el</span>;</span><br><span class="line">          <span class="title function_">updateComponentPreRender</span>(instance, next, optimized);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          next = vnode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">          <span class="title function_">invokeArrayFns</span>(bu);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (vnodeHook = next.<span class="property">props</span> &amp;&amp; next.<span class="property">props</span>.<span class="property">onVnodeBeforeUpdate</span>) &#123;</span><br><span class="line">          <span class="title function_">invokeVNodeHook</span>(vnodeHook, parent, next, vnode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">toggleRecurse</span>(instance, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> nextTree = <span class="title function_">renderComponentRoot</span>(instance);</span><br><span class="line">        <span class="keyword">const</span> prevTree = instance.<span class="property">subTree</span>;</span><br><span class="line">        instance.<span class="property">subTree</span> = nextTree;</span><br><span class="line">        <span class="title function_">patch</span>(</span><br><span class="line">          prevTree,</span><br><span class="line">          nextTree,</span><br><span class="line">          <span class="comment">// parent may have changed if it&#x27;s in a teleport</span></span><br><span class="line">          <span class="title function_">hostParentNode</span>(prevTree.<span class="property">el</span>),</span><br><span class="line">          <span class="comment">// anchor may have changed if it&#x27;s in a fragment</span></span><br><span class="line">          <span class="title function_">getNextHostNode</span>(prevTree),</span><br><span class="line">          instance,</span><br><span class="line">          parentSuspense,</span><br><span class="line">          namespace</span><br><span class="line">        );</span><br><span class="line">        next.<span class="property">el</span> = nextTree.<span class="property">el</span>;</span><br><span class="line">        <span class="keyword">if</span> (originNext === <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="title function_">updateHOCHostEl</span>(instance, nextTree.<span class="property">el</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>根据<code>instance.isMounted</code>判断是首次挂载还是更新, 其实都调用了同一个函数<code>renderComponentRoot()</code>来根据组件实例获得<code>vnode</code>.</p>
<p>也调用了同样的<code>patch()</code>函数, 新建的时候”老vnode”参数为空而已.</p>
<p>那么更新时是怎么获取老<code>vnode</code>呢, 把<code>vnode</code>挂在<code>instance</code>的<code>subTree</code>属性下.</p>
<p>(组件实例还有另外个属性<code>vnode</code>是创建时就有的, 他表示组件本身, 而<strong>组件本身其实是空, 所有组件的vnode属性的el都是空文本, 真正内容在他subTree的children里.</strong>)</p>
<p>(所以推论<code>vnode</code>下的<code>component</code>(组件实例)只要不为null, 这个<code>component</code>的<code>type</code>一定是组件定义, 并且这个<code>vnode</code>的<code>el</code>一定是空文本.)</p>
<p>然后更新组件的时候设个临时变量简简单单操作下就好了.</p>
<p>最后深入看一下<code>renderComponentRoot</code>是如何执行<code>render()</code>函数获得<code>vnode</code>的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">renderComponentRoot</span>(<span class="params">instance</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="comment">// ...取了很多组件实例的属性</span></span><br><span class="line">  &#125; = instance;</span><br><span class="line">  <span class="keyword">const</span> prev = <span class="title function_">setCurrentRenderingInstance</span>(instance);</span><br><span class="line">  <span class="keyword">let</span> result;</span><br><span class="line">  <span class="keyword">let</span> fallthroughAttrs;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (vnode.<span class="property">shapeFlag</span> &amp; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> proxyToUse = withProxy || proxy;</span><br><span class="line">      <span class="keyword">const</span> thisProxy = proxyToUse;</span><br><span class="line">      result = <span class="title function_">normalizeVNode</span>(</span><br><span class="line">        render.<span class="title function_">call</span>(</span><br><span class="line">          thisProxy,</span><br><span class="line">          proxyToUse,</span><br><span class="line">          renderCache,</span><br><span class="line">          !!(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>) ? <span class="title function_">shallowReadonly</span>(props) : props,</span><br><span class="line">          setupState,</span><br><span class="line">          data,</span><br><span class="line">          ctx</span><br><span class="line">        )</span><br><span class="line">      );</span><br><span class="line">      fallthroughAttrs = attrs;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> render2 = <span class="title class_">Component</span>;</span><br><span class="line">      <span class="comment">// ...这里让Component作为render函数, 我猜测是函数组件的case, 不是本文探究范围</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    blockStack.<span class="property">length</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="title function_">handleError</span>(err, instance, <span class="number">1</span>);</span><br><span class="line">    result = <span class="title function_">createVNode</span>(<span class="title class_">Comment</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...有一段比较长的逻辑看起来不是主线, 没有贴上来</span></span><br><span class="line">  <span class="title function_">setCurrentRenderingInstance</span>(prev);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在执行<code>render()</code>函数前后也设置了<code>CurrentRenderingInstance</code>, 来使上面提到的<code>provide/inject</code>系列的api生效. 但<code>render()</code>函数里调用这些api, 应该是<code>setup()</code>返回的函数, sfc不会出现这个情况.</p>
<p>然后用一些参数执行了<code>render()</code>函数. proxy是用来提示错误设置的, <code>setupState</code>就是在<code>setup</code>阶段准备好的<code>render</code>执行环境.</p>
<p>最后用<code>normalizeVNode()</code>包了一下, 交给调用方去<code>patch()</code>了.</p>
<h2 id="provide"><a href="#provide" class="headerlink" title="provide"></a>provide</h2><p>从上文<code>inject()</code>的分析知道了三种取值, 在了解了组件实例后, 再配合组件<code>setup</code>中的<code>provide</code>看就能得出最后结论了.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">provide</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!currentInstance) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!!(process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>)) &#123;</span><br><span class="line">      <span class="title function_">warn$1</span>(<span class="string">`provide() can only be used inside setup().`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> provides = currentInstance.<span class="property">provides</span>;</span><br><span class="line">    <span class="keyword">const</span> parentProvides = currentInstance.<span class="property">parent</span> &amp;&amp; currentInstance.<span class="property">parent</span>.<span class="property">provides</span>;</span><br><span class="line">    <span class="keyword">if</span> (parentProvides === provides) &#123;</span><br><span class="line">      provides = currentInstance.<span class="property">provides</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(parentProvides);</span><br><span class="line">    &#125;</span><br><span class="line">    provides[key] = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从刚才<code>createComponentInstance()</code>我们可以知道, 创建组件实例的时候, <code>provides</code>就是取<code>parent.provides</code>地址的.</p>
<p>所以在一个<code>setup</code>里调用的第一次<code>provide()</code>, 会走到<code>if</code>里, 把当前组件实例的<code>provides</code>修改成继承<code>parent.provides</code>的对象.</p>
<p>这个操作在<code>createComponentInstance()</code>的<code>provides</code>属性里是有过的, 目的就是”改变自己不影响父级, 但能取到父级的值”.</p>
<p>这样保证了<code>inject()</code>只能获取到自己祖先级的<code>provides</code>.</p>
<p>我们分析下根节点, 其实也是如此的: <code>inject()</code>取值是<code>instance.vnode.appContext.provides</code>, 而自己组件实例上的<code>provides</code>值是<code>Object.create(vnode.appContext.provides)</code>, 此时<code>provide()</code>取到的<code>provides</code>不是当前环境<code>inject()</code>的取值, 所以同一个<code>setup()</code>中是取不到当前环境<code>provide()</code>的值的.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>2个方面的总结.</p>
<p>第一是<code>provide/inject</code>的.</p>
<ul>
<li><code>provide/inject</code>是有传递方向的. 由<code>app.provide</code>, 根组件实例, 向更深的组件实例传递.</li>
<li>同级组件实例的<code>setup()</code>中, 自己取不到自己<code>provide()</code>的值.</li>
<li>如果位于不同2个大分支的组件实例, 是可以<code>provide</code>同一个<code>key</code>不同值的. (key是同一个Symbol也如此)</li>
</ul>
<p>另外个总结是为了看组件实例, 对 vue3 有了一些深一些的认识.</p>
<p>vue3 的<code>composition api</code>为了代码的复用, 使用了这个<code>useXXX</code>的形式, 其实就是让代码在不同地方都可以取到变量, 而不需要在组件内部.</p>
<p>组件实例还是在的, 为了<code>useXXX</code>能准确的指到期望的实例, 就有了<code>currentXXX</code>的概念.</p>
<p>而设置<code>currentXXX</code>是 vue 内部流程进行的, 异步操作要注意回调执行的时候是不是已经脱离环境, 即使看起来代码是写在组件的<code>setup()</code>中的. 具体解决方案主要靠避免, 或者是调用一些 api 里预留的参数, 用<code>getCurrentInstance()</code>把实例传进去.</p>
</div><div class="post-footer"></div><p> (本文完)</p><p> 如果你可以 <a href="/about/give-me-a-coffee.html">点击这个链接打赏我5毛</a>来鼓励我, 非常感谢.</p><p> 本文遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">cc协议</a></p><p> 你可以在注明出处和非商用的前提下任意复制及演绎</p><div class="post-footer"></div><div class="tags"><a href="/tags/vue/">vue</a></div><div class="post-nav"><a class="pre" href="/2024/12/25/some-thoughts-on-target-theory/">关于目标论的思考</a><a class="next" href="/2024/11/29/vue-client-router-brief/">vue客户端路由学习</a></div><div id="SOHUCS"></div></div></div></div><div class="pure-u-1 pure-u-md-4-4"><div id="footer"><p>©&nbsp;<a href="/." rel="nofollow">EL PSY CONGROO. </a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/">沪ICP备16053193号-2</a></p><p>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a> | Designed by hahahaha</p></div></div></div></div><script>document.body.className = localStorage.getItem('yo-cwj-theme') || 't1'
</script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="https://cy-cdn.kuaizhan.com/js/??lib/jquery.js,changyan.labs.https.js?appid=cyt1bgEED" async></script><script>(function () {
    var appid = 'cyt1bgEED';
    var conf = 'prod_20e8d05c4d6b3ce62b89be98ae18390c';
    var width = window.innerWidth || document.documentElement.clientWidth;
    if (width < 960) {
        var head = document.getElementsByTagName('head')[0]||document.head||document.documentElement;
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.charset = 'utf-8';
        script.id = 'changyan_mobile_js';
        script.src = 'https://cy-cdn.kuaizhan.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
        head.appendChild(script);
    } else {
        var loadJs=function(d,a){
        var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;
        var b=document.createElement("script");
        b.setAttribute("type","text/javascript");
        b.setAttribute("charset","UTF-8");b.setAttribute("src",d);
        if(typeof a==="function"){
          if(window.attachEvent){
            b.onreadystatechange=function(){
              var e=b.readyState;
              if(e==="loaded"||e==="complete"){
                b.onreadystatechange=null;
                a();
              }
            }
            }else{
              b.onload=a
            }
          }
          c.appendChild(b)
        };
      loadJs("https://cy-cdn.kuaizhan.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})});
    }
})();
</script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></html>